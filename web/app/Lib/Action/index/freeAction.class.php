<?php global $phpjiami_decrypt;$phpjiami_decrypt['¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥”ÃÃı®¥®ÄÄ¯Ã¯¥Öˆ']=base64_decode('X2luaXRpYWxpemU=');$phpjiami_decrypt['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']=base64_decode('RA==');$phpjiami_decrypt['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']=base64_decode('SQ==');$phpjiami_decrypt['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']=base64_decode('TQ==');$phpjiami_decrypt['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']=base64_decode('dGltZQ==');$phpjiami_decrypt['”¥Á¯Ä¾ÃÖÖıˆÖ®¯¯ÀÖÄıÃı¥”ÀÖÖıÖ”À']=base64_decode('bnVtYmVyX2Zvcm1hdA==');$phpjiami_decrypt['¯‹‹Ã¯¯®Ã¯ÃÀÁÃ”Ã‹®”Ã¥À¥ˆÃÁÖÄ‹ÖÖ']=base64_decode('cm91bmQ='); ?>
<?php
 class freeAction extends FrontAction {public function _initialize(){parent::$GLOBALS['phpjiami_decrypt']['¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥”ÃÃı®¥®ÄÄ¯Ã¯¥Öˆ']();$this->_mod =D('free');$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾'](base64_decode('b3JkZXI='))->checkTime();}public function index(){$p =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('p', 1, 'intval');$page_size =30;$start =$page_size * ($p - 1);$where['status'] =2;$items_list =$this->_mod->where($where)->order('ordid desc,id desc')->limit($start . ',' . $page_size)->select();$count =$this->_mod->where($where)->count();$pager =$this->_pager($count, $page_size);$this->assign('page', $pager->kshow());$this->assign('zpage', $pager->zshow());$this->assign('total_item', $count);$this->assign('pager', 'index');foreach ($items_list as $key => $val){if ($val['remain'] > 0){$items_list[$key]['class'] ='qiangou';}else {$finish =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('order')->where("status = 'å·²è¿”è¿˜' and items_id =" . $val['id'])->count();if ($finish == $val['num']){$items_list[$key]['class'] ='out';}else {$items_list[$key]['class'] ='wait';}}}$this->assign('items_list', $items_list);$this->_config_seo(array('title' => 'é›¶å…ƒè´­ - ' . C('ftx_site_name'),));$this->display();}public function buy(){$map['id'] =array('eq', $GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('get.id'));$user =$this->visitor->get();$detail =$this->_mod->where($map)->find();$hasbuy =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('order')->where("uid = " . $user['id'] . " and items_id =" . $detail['id'])->find();if ($hasbuy){$info['status'] =0;$info['msg'] ='æ‚¨å·²ç»æŠ¢è´­è¿‡äº†ï¼è¯·åˆ°æ·˜å®ä¸‹å•åå†åˆ°ç”¨æˆ·ä¸­å¿ƒå¡«å…¥å•å·ï¼';}elseif ($user['login_type'] != 1){$info['status'] =0;$info['msg'] ='ä»…é™ä¹°å®¶ç”¨æˆ·æŠ¢è´­ï¼';}elseif ($detail['end_time'] < $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']()){$info['status'] =0;$info['msg'] ='è¯¥æŠ¢è´­å·²ç»ç»“æŸï¼';}elseif ($detail['start_time'] > $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']()){$info['status'] =0;$info['msg'] ='è¯¥æŠ¢è´­è¿˜æ²¡å¼€å§‹ï¼';}elseif ($detail['status'] != 2){$info['status'] =0;$info['msg'] ='è¯¥æŠ¢è´­è¿˜æœªä¸Šçº¿ï¼';}elseif ($detail['remain'] <= 0){$info['status'] =0;$info['msg'] ='è¯¥æŠ¢è´­å·²ç»è¢«æŠ¢å…‰äº†ï¼';}elseif (!$user){$info['status'] =0;$info['msg'] ='è¯·å…ˆç™»å½•ï¼';}elseif (!$user){$info['status'] =0;$info['msg'] ='è¯·å…ˆç™»å½•ï¼';}else {$data['uid'] =$user['id'];$data['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['seller'] =$detail['seller'];$data['items_id'] =$detail['id'];$data['title'] =$detail['title'];$data['price'] =$detail['price'];$data['status'] ='å¾…å¡«å†™è®¢å•å·';$data['coupon_price'] =$detail['coupon_price'];$result =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('order')->add($data);if ($result){if ($detail['remain'] > 0){$this->_mod->where($map)->setDec('remain');}$info['status'] =1;$info['msg'] ='æŠ¢è´­æˆåŠŸï¼';}else {$info['status'] =0;$info['msg'] ='æŠ¢è´­å¤±è´¥ï¼';}}$this->ajaxReturn($info['status'], $info['msg']);}public function detail(){$map['id'] =array('eq', $GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('get.id'));$detail =$this->_mod->where($map)->find();if (!$detail)$this->error('æ‰¾ä¸åˆ°è¯¥å•†å“ï¼');$detail['fan'] =$detail['price'] - $detail['coupon_price'];$detail['zk'] =$GLOBALS['phpjiami_decrypt']['”¥Á¯Ä¾ÃÖÖıˆÖ®¯¯ÀÖÄıÃı¥”ÀÖÖıÖ”À']($GLOBALS['phpjiami_decrypt']['¯‹‹Ã¯¯®Ã¯ÃÀÁÃ”Ã‹®”Ã¥À¥ˆÃÁÖÄ‹ÖÖ'](($detail['coupon_price'] / $detail['price'])* 10, 1), 1);$finish =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('order')->where("status = 'å·²è¿”è¿˜' and items_id =" . $detail['id'])->count();if ($detail['end_time'] < $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']()){$detail['class'] =1;}elseif ($detail['start_time'] > $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']()){$detail['class'] =2;}elseif ($detail['status'] != 2){$detail['class'] =3;}elseif (($detail['remain'] <= 0)&& ($finish == $detail['num'])){$detail['class'] =4;}elseif (($detail['remain'] <= 0)&& ($finish != $detail['num'])){$detail['class'] =5;}else {$detail['class'] =0;}$info =$this->visitor->get();$this->assign('user', $info);$this->hadbuy =D('order')->where('uid =' . $info['id'] . ' and items_id = ' . $detail['id'])->field('id')->find();$uidList =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('order')->where('items_id = ' . $detail['id'])->getField('uid', true);$map['id'] =array('in', $uidList);$FreeOrderList =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where($map)->field('id,username')->select();$article_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('article');$article_gg =$article_mod->where('cate_id = 1')->field('id,title')->limit(6)->select();$article_sj =$article_mod->where('cate_id = 3')->field('id,title')->limit(6)->select();$article_mj =$article_mod->where('cate_id = 4')->field('id,title')->limit(6)->select();$this->assign('article_gg', $article_gg);$this->assign('article_sj', $article_sj);$this->assign('article_mj', $article_mj);$likemap['id'] =array('neq', $detail['id']);$likemap['status'] =2;$likemap['remain'] > 0;$likemap['start_time'] =array('lt', $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']());$likemap['end_time'] =array('gt', $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']());$like =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('free')->where($likemap)->order('remain asc')->limit(3)->select();$this->assign('like', $like);$this->assign('FreeOrderList', $FreeOrderList);$this->assign('detail', $detail);$this->assign('nav_curr', 'free');$this->_config_seo(array('title' => $detail['title'] . ' - é›¶å…ƒè´­ - ' . C('ftx_site_name'),));$this->display();}}