<?php global $phpjiami_decrypt;$phpjiami_decrypt['Ž¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥Ž”ÃÃý®¥®ÄÄ¯Ã¯¥Öˆ']=base64_decode('X2luaXRpYWxpemU=');$phpjiami_decrypt['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']=base64_decode('c3RydG90aW1l');$phpjiami_decrypt['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']=base64_decode('ZGF0ZQ==');$phpjiami_decrypt['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']=base64_decode('Qw==');$phpjiami_decrypt['Ã¯Ã¯ÄýÁ‹Ãýý®ýˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃŽ¥Àý']=base64_decode('TQ=='); ?>
<?php
 class signAction extends UsersAction {public function _initialize(){parent::$GLOBALS['phpjiami_decrypt']['Ž¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥Ž”ÃÃý®¥®ÄÄ¯Ã¯¥Öˆ']();if (!$this->visitor->is_login){IS_AJAX && $this->ajaxReturn(0, L('login_please').'11');$this->redirect('user/login');}$this->_sign_mod =D('sign');$this->_user_mod =D('user');$this->_sign_log_mod =D('sign_log');$this->_score_log_mod =D('score_log');}public function ajax_sign_head(){$data =array('uid' => $this->visitor->info['id'], 'username' => $this->visitor->info['username'], );$sign=$this->_sign_mod->where($data)->find();if($sign){$last_date=$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d'));if($last_date==$sign['last_date']){$this->ajaxReturn(1,'å·²ç­¾åˆ°');}else {$this->ajaxReturn(0,'ç­¾åˆ°å¾—ç§¯åˆ†');}}else {$this->ajaxReturn(0,'ç­¾åˆ°å¾—ç§¯åˆ†');}}public function ajax_sign(){$data =array('uid' => $this->visitor->info['id'], 'username' => $this->visitor->info['username'], );$point_score =$this->point();if (!$this->_sign_mod->where($data)->find()){$score_data =array('score'=>array('exp','score+'.$point_score), 'sign_time'=>$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Ymd')));$this->_user_mod->where(array('id'=>$data['uid']))->setField($score_data);$this->_sign_mod->create($data);$this->_sign_mod->add();$data['score'] =$point_score;$this->_sign_log_mod->create($data);$this->_sign_log_mod->add();$score_log_data['uid'] =$this->visitor->info['id'];$score_log_data['uname'] =$this->visitor->info['username'];$score_log_data['action'] ='sign';$score_log_data['score'] =$point_score;$this->_score_log_mod->create($score_log_data);$this->_score_log_mod->add();}else{$sign_date=$this->_sign_mod->where($data)->find();$last_date=$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d'));if($sign_date['last_date']==$last_date){$cl =new calender();$data['table']=$cl->sign_calender();$data['point']=$point_score;$data['tmr_point']=$point_score ;$this->ajaxReturn(1, L('sign_system'), $data,avatar($this->visitor->info['id'],100));}else if($sign_date['last_date']+86400==$last_date){$score_data =array('score'=>array('exp','score+'.$point_score), 'sign_time'=>$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Ymd')));$this->_user_mod->where(array('id'=>$data['uid']))->setField($score_data);$this->_sign_mod->where($data)->setInc('sign_count');$this->_sign_mod->where($data)->setField('last_date',strtotime(date('Ymd')));$data['score'] =$point_score;$this->_sign_log_mod->create($data);$this->_sign_log_mod->add();$score_log_data['uid'] =$this->visitor->info['id'];$score_log_data['uname'] =$this->visitor->info['username'];$score_log_data['action'] ='sign';$score_log_data['score'] =$point_score;$this->_score_log_mod->create($score_log_data);$this->_score_log_mod->add();}else{$score_data =array('score'=>array('exp','score+'.$point_score), 'sign_time'=>$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Ymd')));$this->_user_mod->where(array('id'=>$data['uid']))->setField($score_data);$sign_data=$data;$sign_data['sign_count'] ='1';$sign_data['last_date'] =$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Ymd'));$this->_sign_mod->where($data)->save($sign_data);$data['score'] =$point_score;$this->_sign_log_mod->create($data);$this->_sign_log_mod->add();$score_log_data['uid'] =$this->visitor->info['id'];$score_log_data['uname'] =$this->visitor->info['username'];$score_log_data['action'] ='sign';$score_log_data['score'] =$point_score;$this->_score_log_mod->create($score_log_data);$this->_score_log_mod->add();}}$cl =new calender();$data['table']=$cl->sign_calender();$data['point']=$point_score;if($sign_info =$this->_sign_mod->field('id,username,last_date,sign_count')->where(array('uid'=>$this->visitor->info['id']))->find()){if($sign_info['sign_count']>= $GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')){$data['tmr_point']=$point_score;}else{$data['tmr_point']=$point_score + $GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');}}$this->ajaxReturn(1, L('sign_system'), $data,avatar($this->visitor->info['id'],100));}public function point(){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign');$sign_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄýÁ‹Ãýý®ýˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃŽ¥Àý']('sign');$sign_info =$sign_mod->field('id,username,last_date,sign_count')->where(array('uid'=>$this->visitor->info['id']))->find();$last_date=$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d'));if($sign_info){if($sign_info['last_date']==$last_date){if($sign_info['sign_count']>=1){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign')+ ($sign_info['sign_count'])*$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');if($sign_info['sign_count']>= $GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign')+ ($GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')-1)*$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');}}else{$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign');}}else if($sign_info['last_date']+86400==$last_date){if($sign_info['sign_count']>=1){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign')+ ($sign_info['sign_count'])*$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');if($sign_info['sign_count']>= $GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign')+ ($GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')-1)*$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');}}else{$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign');}}else{$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign');}}return $jinbi;}public function signstatus(){$sign_mod=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄýÁ‹Ãýý®ýˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃŽ¥Àý']('sign');$sign_info =$sign_mod->field('id,username,last_date,sign_count')->where(array('uid'=>$this->visitor->info['id']))->find();$last_date=$GLOBALS['phpjiami_decrypt']['ýÁŽˆý”ÖýÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯ÃŽ']($GLOBALS['phpjiami_decrypt']['¾”ýÁ®Ö®ÄÄ¯Ž¾ý‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d'));if($sign_info['last_date']==$last_date){if($sign_info['sign_count']>1){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign')+ ($sign_info['sign_count']-1)*$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');if($sign_info['sign_count']> $GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')){$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign')+ ($GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_day')-1)*$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign_add');}}else{$jinbi =$GLOBALS['phpjiami_decrypt']['ŽÃÃÄ”Ö®ÁŽýÀÃÄÃ¥ÄÖ”ÖŽ‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('ftx_score_rule.sign');}$user_mod=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄýÁ‹Ãýý®ýˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃŽ¥Àý']('user');$user_info =$user_mod->field('id,username,score')->where(array('id'=>$this->visitor->info['id']))->find();$result['today'] ='å·²ç­¾åˆ° + '.$jinbi;$result['score'] =$user_info['score'];$this->ajaxReturn(1, 'ok', $result);}else{$this->ajaxReturn(0, 'sign_out');}}}