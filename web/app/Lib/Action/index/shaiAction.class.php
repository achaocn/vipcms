<?php global $phpjiami_decrypt;$phpjiami_decrypt['¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥”ÃÃı®¥®ÄÄ¯Ã¯¥Öˆ']=base64_decode('X2luaXRpYWxpemU=');$phpjiami_decrypt['ÃÃÄ”Ö®ÁıÀÃÄÃ¥ÄÖ”Ö‹Ö¥ÃÄ¥®ˆÄÖ¾Á']=base64_decode('Qw==');$phpjiami_decrypt['¾Ã‹ı¯ÖÃıı¯Ö®ÀÁÁÖÖ‹ÃÖÖÃÄÀ¥Á¾¥Ãˆ']=base64_decode('Uw==');$phpjiami_decrypt['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']=base64_decode('TQ==');$phpjiami_decrypt['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']=base64_decode('SQ==');$phpjiami_decrypt['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']=base64_decode('aW50dmFs');$phpjiami_decrypt['ÀÀıÀ”¾ˆ‹¥ÃÖÃ¯ÖÀÃıˆÃÃ””À¯¯”ÖÖ¾¥‹']=base64_decode('YXZhdGFy');$phpjiami_decrypt['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']=base64_decode('ZGF0ZQ==');$phpjiami_decrypt['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”']=base64_decode('YW5vbnltb3Vz');$phpjiami_decrypt['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']=base64_decode('RA==');$phpjiami_decrypt['ÃÁ¥ÃÖÄˆ®Ö¾¾‹¯ÄˆÖÖÁ”Ö¥¯¯Ä¾ÀˆÄˆ']=base64_decode('aW1wbG9kZQ==');$phpjiami_decrypt['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']=base64_decode('dGltZQ=='); ?>
<?php
 class shaiAction extends FrontAction {public function _initialize(){parent::$GLOBALS['phpjiami_decrypt']['¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥”ÃÃı®¥®ÄÄ¯Ã¯¥Öˆ']();$GLOBALS['phpjiami_decrypt']['ÃÃÄ”Ö®ÁıÀÃÄÃ¥ÄÖ”Ö‹Ö¥ÃÄ¥®ˆÄÖ¾Á'](base64_decode('REFUQV9DQUNIRV9USU1F'),$GLOBALS['phpjiami_decrypt']['ÃÃÄ”Ö®ÁıÀÃÄÃ¥ÄÖ”Ö‹Ö¥ÃÄ¥®ˆÄÖ¾Á'](base64_decode('ZnR4X3NpdGVfY2FjaGV0aW1l')));$info =$this->visitor->get();if($info){$file='shai_paixun';if(!$GLOBALS['phpjiami_decrypt']['¾Ã‹ı¯ÖÃıı¯Ö®ÀÁÁÖÖ‹ÃÖÖÃÄÀ¥Á¾¥Ãˆ']($file)){$sql='select t.*,@rownum:=@rownum+1 AS rownum from (SELECT id,username ,shai_score
FROM '.$GLOBALS['phpjiami_decrypt']['ÃÃÄ”Ö®ÁıÀÃÄÃ¥ÄÖ”Ö‹Ö¥ÃÄ¥®ˆÄÖ¾Á']('DB_PREFIX').'user where status=1 order by shai_score desc) t,(SELECT @rownum:=0) r';$list=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']()->query($sql);$GLOBALS['phpjiami_decrypt']['¾Ã‹ı¯ÖÃıı¯Ö®ÀÁÁÖÖ‹ÃÖÖÃÄÀ¥Á¾¥Ãˆ']($file,$list);}$list=$GLOBALS['phpjiami_decrypt']['¾Ã‹ı¯ÖÃıı¯Ö®ÀÁÁÖÖ‹ÃÖÖÃÄÀ¥Á¾¥Ãˆ']($file);foreach($list as $item){if($item['id']==$info['id']){if($info['shai_num']){$info['rownum']=$item['rownum'];}else {$info['rownum']="æ— ";}break;}}}$this->assign('info', $info);$this->assign('nav_curr', 'shai');}public function index(){$sort =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('sort', 'new', 'trim');switch ($sort){case 'hot': $sort_order ='ordid ASC ,buy_num DESC,id DESC';break;case base64_decode('bmV3'): $sort_order ='ordid ASC ,id DESC';break;}$where =array('status' => '1');$shaiorder =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('shaiorder');if(IS_AJAX){$per=10;$p=$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('page',2);$item_list=array();$item_list =$shaiorder->where($where)->order($sort_order)->limit(($p-1)*$per,$per)->select();if($item_list){foreach($item_list as $k=>$item){$count_order=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_order')->where('item_id='.$item['id'].' and status in(0,1)')->count('id');$item_list[$k]['order_count']=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']($count_order);$item_list[$k]['thumb']=$GLOBALS['phpjiami_decrypt']['ÀÀıÀ”¾ˆ‹¥ÃÖÃ¯ÖÀÃıˆÃÃ””À¯¯”ÖÖ¾¥‹']($item['user_id'], 100);$item_list[$k]['time1']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y.m.d',$item['addtime']);$item_list[$k]['time2']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('H:i:s',$item['addtime']);$item_list[$k]['nickname']=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('id='.$item['user_id'])->getField('nickname');$item_list[$k]['username']=$item_list[$k]['nickname']?$item_list[$k]['nickname']:$item['username'];$item_list[$k]['username']==$GLOBALS['phpjiami_decrypt']['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”']($item_list[$k]['username']);}$this->ajaxReturn('200','',$item_list);}else {$this->ajaxReturn('201');}}else {$per=30;$item_list=array();$item_list =$shaiorder->where($where)->order($sort_order)->limit($per)->select();if($item_list){foreach($item_list as $k=>$item){$count_order=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_order')->where('item_id='.$item['id'].' and status in(0,1)')->count('id');$item_list[$k]['order_count']=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']($count_order);$nicknames=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('id='.$item['user_id'])->getField('nickname');$item_list[$k]['username']=$GLOBALS['phpjiami_decrypt']['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”'](($nicknames?$nicknames:$item['username']));}}$orderlist1=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('status=1 and shai_num>0')->field('id,username,shai_num,shai_score,nickname')->order('shai_score desc')->limit(10)->select();$orderlist2=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('status=1 and shai_num>0')->field('id,username,shai_num,shai_score,nickname')->order('shai_num desc')->limit(10)->select();$orderlist3=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']()->query('select sum(score) as sumscore,uid,uname from '.C('DB_PREFIX').'score_log where action="shaidan" group by uid limit 10');if($orderlist3){foreach($orderlist3 as $k=>$item){$nickname=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('id='.$item['uid'])->getField('nickname');$orderlist3[$k]['uname']=$GLOBALS['phpjiami_decrypt']['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”'](($nickname?$nickname:$item['uname']));}}$this->assign('orderlist1',$orderlist1);$this->assign('orderlist2',$orderlist2);$this->assign('orderlist3',$orderlist3);$this->assign('item_list', $item_list);$this->assign('nav_curr', 'shai');$this->assign('sort', $sort);$this->_config_seo(C('ftx_seo_config.promo_index'));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/sunSquare.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æ™’å•å¹¿åœº');}else {$banner=$this->getbanner(13);$this->assign('banner',$banner);}$this->display('index');}}public function order(){if(!$this->ismobile){$this->redirect('shai/index');}$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/squareChart.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æ™’å•å¹¿åœº');$this->_config_seo(C('ftx_seo_config.promo_index'));$this->display();}public function ajaxlist(){if(!$this->ismobile){$this->redirect('shai/index');}$per=10;$typeid=$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('post.typeid');$page=$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('post.page',1);if($typeid==1){$orderlist=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('status=1 and shai_num>0')->field('id,username,shai_num,shai_score,nickname')->order('shai_score desc')->limit(($page-1)*$per,$per)->select();if($orderlist){foreach($orderlist as $k=>$item){$orderlist[$k]['thumb']=$GLOBALS['phpjiami_decrypt']['ÀÀıÀ”¾ˆ‹¥ÃÖÃ¯ÖÀÃıˆÃÃ””À¯¯”ÖÖ¾¥‹']($item['id'], 100);$orderlist[$k]['username']=$item['nickname']?$item['nickname']:$item['username'];$orderlist[$k]['username']=$GLOBALS['phpjiami_decrypt']['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”']($orderlist[$k]['username']);}}}elseif($typeid==2){$orderlist=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('status=1 and shai_num>0')->field('id,username,shai_num,shai_score,nickname')->order('shai_num desc')->limit(($page-1)*$per,$per)->select();if($orderlist){foreach($orderlist as $k=>$item){$orderlist[$k]['thumb']=$GLOBALS['phpjiami_decrypt']['ÀÀıÀ”¾ˆ‹¥ÃÖÃ¯ÖÀÃıˆÃÃ””À¯¯”ÖÖ¾¥‹']($item['id'], 100);$orderlist[$k]['username']=$item['nickname']?$item['nickname']:$item['username'];$orderlist[$k]['username']=$GLOBALS['phpjiami_decrypt']['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”']($orderlist[$k]['username']);}}}elseif($typeid==3){$orderlist=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']()->query('select sum(score) as shai_score,uid as id,uname from '.C('DB_PREFIX').'score_log where action="shaidan" group by uid limit '.($page-1)*$per.','.$per);if($orderlist){foreach($orderlist as $k=>$item){$nickname=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user')->where('id='.$item['id'])->getField('nickname');$nickname=$nickname?$GLOBALS['phpjiami_decrypt']['Ö¯¥Ãˆ®¾¾ÁÃ¯Ã‹®ÃÖÃÖÀÄˆÃÀÀ‹ÖÖı”']($nickname):$nickname($item['uname']);$orderlist[$k]['username']=$nickname;$orderlist[$k]['thumb']=$GLOBALS['phpjiami_decrypt']['ÀÀıÀ”¾ˆ‹¥ÃÖÃ¯ÖÀÃıˆÃÃ””À¯¯”ÖÖ¾¥‹']($item['id'], 100);}}}if($orderlist){$this->ajaxReturn('200','',$orderlist);}else {$this->ajaxReturn('201','æ²¡æœ‰ä¿¡æ¯');}}public function ajax(){$sort =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('sort', 'id desc', 'trim');$per=30;$page=$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('page',2);$where =array('status' => '1');$shaiorder =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('shaiorder');$item_list=array();$str="";$item_list =$shaiorder->where($where)->order($sort_order)->limit(($page-1)*$per. ',' . $per)->select();if($item_list){foreach($item_list as $k=>$item){$str.='<div class="box">
                    <a><img class="b_img" src="/'.$item['shai_pic'].'"></a>
                    <div class="b_title">
                        <div class="b_title2">
                            '.$item['desc'].'
                        </div>
                    </div>
                    <div class="b_cont">
                        <img src="'.$GLOBALS['phpjiami_decrypt']['ÀÀıÀ”¾ˆ‹¥ÃÖÃ¯ÖÀÃıˆÃÃ””À¯¯”ÖÖ¾¥‹']($item['user_id'], 100).'" alt="'.$item['username'].'">
                        <span class="b_cont2">
                           '.$item['username'].'æ™’å•<br>
                            <span class="b_pric">
                                åˆ°æ‰‹ä»·ï¼š<span>ï¿¥'.$item['orderprice'].'</span>
                            </span>
                            <span>
                                å¥–åŠ±ç§¯åˆ†ï¼š<span>'.$item['score'].'</span>
                            </span>
                        </span>
                    </div>
                </div>';}}echo $str;}public function cate(){$cid =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('cid', '', 'intval');$sort =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('sort', 'hot', 'trim');switch ($sort){case 'hot': $sort_order ='ordid ASC ,buy_num DESC,id DESC';break;case base64_decode('bmV3'): $sort_order ='ordid ASC ,id DESC';break;}$cname =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('score_item_cate')->get_name($cid);$where =array('status' => '1');$cid && $where['cate_id'] =$cid;$score_item =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_item');$count =$score_item->where($where)->count('id');$pager =$this->_pager($count, 20);$item_list =$score_item->where($where)->order($sort_order)->limit($pager->firstRow . ',' . $pager->listRows)->select();$this->assign('item_list', $item_list);$this->assign('page_bar', $pager->fshow());$this->assign('cid', $cid);$this->assign('sort', $sort);$this->assign('cname', $cname);$this->_config_seo(C('ftx_seo_config.gift'), array('cate_name' => $cname,));$this->display('index');}public function lists($cid){$sort =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('sort', 'hot', 'trim');switch ($sort){case 'hot': $sort_order ='ordid ASC ,buy_num DESC,id DESC';break;case base64_decode('bmV3'): $sort_order ='ordid ASC ,id DESC';break;}$cname =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('score_item_cate')->get_name($cid);$where =array('status' => '1');$cid && $where['cate_id'] =$cid;$score_item =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_item');$count =$score_item->where($where)->count('id');$pager =$this->_pager($count, 20);$item_list =$score_item->where($where)->order($sort_order)->limit($pager->firstRow . ',' . $pager->listRows)->select();$this->assign('item_list', $item_list);$this->assign('page_bar', $pager->fshow());$this->assign('cid', $cid);$this->assign('sort', $sort);$this->assign('cname', $cname);$this->_config_seo(C('ftx_seo_config.gift'), array('cate_name' => $cname,));$this->display('index');}public function detail(){$id =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('id', '', 'intval');!$id && $this->_404();$item_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_item');$item =$item_mod->field('id,title,img,score,stock,user_num,price,coupon_price,num_iid,start_time,end_time,buy_num,desc,info')->find($id);$count_order=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_order')->where('item_id='.$item['id'].' and status in(0,1)')->count('id');$item['order_count']=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']($count_order);$tag =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('items')->get_tags_by_title($item['title']);$tags =$GLOBALS['phpjiami_decrypt']['ÃÁ¥ÃÖÄˆ®Ö¾¾‹¯ÄˆÖÖÁ”Ö¥¯¯Ä¾ÀˆÄˆ'](',', $tag);$this->assign('item', $item);$this->_config_seo(C('ftx_seo_config.gift_item'), array('title' => $item['title'], 'tags' => $tags, 'desc' => $item['info'],));$this->display();}public function ec(){!$this->visitor->is_login && $this->ajaxReturn(0, L('login_please'));$id =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('id', '', 'intval');$num =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('num', 1, 'intval');if (!$id || !$num)$this->ajaxReturn(0, L('invalid_item'));$item_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_item');$user_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user');$order_mod =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('score_order');$uid =$this->visitor->info['id'];$uname =$this->visitor->info['username'];$item =$item_mod->find($id);!$item && $this->ajaxReturn(0, L('invalid_item'));!$item['stock'] && $this->ajaxReturn(0, L('no_stock'));if ($item['start_time'] > $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']()){$this->ajaxReturn(0, L('no_start'));}if ($item['end_time'] < $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']()){$this->ajaxReturn(0, L('ending'));}$user_score =$user_mod->where(array('id' => $uid))->getField('score');if ($user_score < $item['score']){$this->ajaxReturn(0, L('no_score'));}$eced_num =$order_mod->where(array('uid' => $uid, 'item_id' => $item['id']))->sum('item_num');if ($item['user_num'] && $eced_num + $num > $item['user_num']){$this->ajaxReturn(0, sprintf(L('ec_user_maxnum'), $item['user_num']));}$this->assign('item', $item);$info =$this->visitor->get();$addressinfo=$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('address')->where('user_id='.$info['id'])->find();$this->assign('addressinfo',$addressinfo);$this->assign('info', $info);$resp =$this->fetch('dialog:gift_address');$this->ajaxReturn(2, 'å…‘æ¢ - ' . $item['title'], $resp);}public function daifu(){!$this->visitor->is_login && $this->ajaxReturn(0, L('login_please'));$id =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('id', '', 'intval');$url =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('url', '', 'trim');$item_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_item');$user_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user');$order_mod =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('score_order');$uid =$this->visitor->info['id'];$uname =$this->visitor->info['username'];if (!$url){$this->ajaxReturn(0, L('daifu_message'));}$item =$item_mod->find($id);!$item && $this->ajaxReturn(0, L('invalid_item'));$order_score =$item['score'];$data =array('uid' => $uid, 'uname' => $uname, 'item_id' => $item['id'], 'item_name' => $item['title'], 'item_num' => '1', 'url' => $url, 'order_score' => $order_score,);if (false === $order_mod->create($data)){$this->ajaxReturn(0, L('ec_failed'));}$order_id =$order_mod->add();$user_mod->where(array('id' => $uid))->setDec('score', $order_score);$score_log_mod =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('score_log');$score_log_mod->create(array('uid' => $uid, 'uname' => $uname, 'action' => 'gift', 'score' => $order_score * -1,));$score_log_mod->add();$item_mod->save(array('id' => $item['id'], 'stock' => $item['stock'] - 1, 'buy_num' => $item['buy_num'] + 1,));$this->ajaxReturn(1, L('ec_success'));}public function address(){!$this->visitor->is_login && $this->ajaxReturn(0, L('login_please'));$item_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_item');$order_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('score_order');$user_mod =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('user');$id =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('id', '', 'intval');$iid =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('iid', '', 'intval');$num =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('num', '', 'intval');$realname =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('realname', '', 'trim');$address =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('address', '', 'trim');$email =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('email', '', 'trim');$resp1 =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('qq', '', 'trim');$mobile =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('mobile', '', 'trim');$province =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('cho_Province', '', 'trim');$city =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('cho_City', '', 'trim');$area =$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('cho_Area', '', 'trim');$addressid=$GLOBALS['phpjiami_decrypt']['ÃÃÁ¾®ÃÁ¯¥‹Ã®‹”¯ˆıı”Ã®Á”¯‹Ä¥ÁÃÁ”']('addressid', '', 'intval');$addressid=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']($addressid);if (!$address && (!$id || !$realname || !$address || !$mobile || !$address)){$this->ajaxReturn(0, L('please_input_address_info'));}$uid =$this->visitor->info['id'];$uname =$this->visitor->info['username'];$item =$item_mod->find($id);!$item && $this->ajaxReturn(0, 'å•†å“ä¸å­˜åœ¨ï¼');!$item['stock'] && $this->ajaxReturn(0, 'å•†å“å·²ç»è¢«æŠ¢å®Œäº†ï¼');$user_score =$user_mod->where(array('id' => $uid))->getField('score');$user_score < $item['score'] && $this->ajaxReturn(0, 'ç§¯åˆ†ä¸å¤Ÿäº†ï¼');$order_score =$num * $item['score'];if ($user_score < $order_score){$this->ajaxReturn(0, L('no_score'));}$eced_num =$order_mod->where(array('uid' => $uid, 'item_id' => $item['id']))->sum('item_num');if ($item['user_num'] && $eced_num + $num > $item['user_num']){$this->ajaxReturn(0, 'æ­¤å•†å“æ¯äººé™å…‘' . $item['user_num'] . 'ä»¶ï¼');}$order_score =$num * $item['score'];$data =array('uid' => $uid, 'uname' => $uname, 'item_id' => $item['id'], 'item_name' => $item['title'], 'item_num' => $num, 'iid' => $iid, 'realname' => $realname, 'address' => $address, 'email' => $email, 'qq' => $resp1, 'mobile' => $mobile, 'order_score' => $order_score, 'add_time' => $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹'](),'province'=>$province,'city'=>$city,'area'=>$area,);if (false === $order_mod->create($data)){$this->ajaxReturn(0, L('ec_failed'));}$order_id =$order_mod->add();if($order_id){if(empty($addressid)){$data['mobile']=$mobile;$data['realname']=$realname;$data['address']=$address;$data['province']=$province;$data['city']=$city;$data['area']=$area;$data['user_id']=$uid;$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı'](base64_decode('YWRkcmVzcw=='))->add($data);}$user_mod->where(array('id' => $uid))->setDec('score', $order_score);$score_log_mod =$GLOBALS['phpjiami_decrypt']['”ÃÖ®ˆÁ¾À”®ˆÃÖ‹‹ÃÁ®ÃÃÃ”¾‹¾‹‹Á‹¾']('score_log');$score_log_mod->create(array('uid' => $uid, 'uname' => $uname, 'action' => 'gift', 'score' => $order_score * -1,));$score_log_mod->add();$item_mod->save(array('id' => $item['id'], 'stock' => $item['stock'] - 1, 'buy_num' => $item['buy_num'] + 1,));$msg =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('msg');$msg->create(array('fuid' => 0, 'fname' => 'SYSTEM', 'tuid' => $uid, 'tname' => $uname, 'info' => ' æ‚¨ç”³è¯·çš„ç§¯åˆ†å…‘æ¢å•†å“ï¼š' . $item['title'] . ' ã€å…‘æ¢æ•°é‡ï¼š' . $num . 'ã€æ¶ˆè€—ç§¯åˆ†ï¼š' . $order_score . 'ã€‚è¯·ç­‰å¾…ç³»ç»Ÿå®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åä¼šå‘è´§ï¼Œè°¢è°¢!', 'add_time' => time(),));$msg->add();}$this->ajaxReturn(1, 'æ­å–œæ‚¨ï¼Œå…‘æ¢æˆåŠŸï¼è¯·ç­‰å¾…å‘è´§');}public function rule(){$info =$GLOBALS['phpjiami_decrypt']['Ã¯Ã¯ÄıÁ‹Ãıı®ıˆÃÃ¾ÃÖÀÄ®ÃÄ”ÖÖÃ¥Àı']('article_page')->find(6);$this->assign('info', $info);$this->_config_seo();$this->display();}}