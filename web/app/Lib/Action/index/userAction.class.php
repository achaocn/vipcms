<?php global $phpjiami_decrypt;$phpjiami_decrypt['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']=base64_decode('dGltZQ==');$phpjiami_decrypt['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']=base64_decode('c3RydG90aW1l');$phpjiami_decrypt['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®']=base64_decode('aGVhZGVy');$phpjiami_decrypt['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']=base64_decode('aW50dmFs');$phpjiami_decrypt['”¾ˆÃÃıˆÁÖ¯ı¾‹ÁÀÖÖÄ¥¥ÖÀÖÖˆˆˆ®ÖÄÄ']=base64_decode('aXNfbnVtZXJpYw==');$phpjiami_decrypt['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ']=base64_decode('c3Vic3Ry');$phpjiami_decrypt['Ä‹ıÖ¯‹®Ã”ÃÖ®‹ÀÖÖÀÀ”ÃÁÖ¥”Ã®‹ÄÃÁÄÖ']=base64_decode('bWQ1');$phpjiami_decrypt['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']=base64_decode('ZGF0ZQ==');$phpjiami_decrypt['ı®”ıÁÁ®ÁÁ¥¾ÃÄ®¯¯®Ã”¥®ˆ¥Ö‹¥Ä”À®']=base64_decode('cHJlZ19tYXRjaA==');$phpjiami_decrypt['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ']=base64_decode('ZXhwbG9kZQ==');$phpjiami_decrypt['ÃÀÖÃˆÁ¥Ã¾ÃÃ‹Ö¾¥ÃÖ¯ÁÄ‹ˆ‹®Ä¯Á®Ö¾”¥']=base64_decode('aXNfZGly');$phpjiami_decrypt['ÃÄıÖ¯Ã‹‹ÃÖˆ¥ˆ”Á¾¯ı®ÁÃ®ˆ‹¯¥ˆÁ®ÖÁ']=base64_decode('bWtkaXI=');$phpjiami_decrypt['Ã¯¾Ã®ı”ı¾ˆ‹¯Ö¾Ö”‹®ˆÁÃÀıÁ¯ˆÃ®']=base64_decode('dW5saW5r');$phpjiami_decrypt['”¯ÀıÃ‹¾‹ˆıı‹”ı¾Ö®Á‹ÃÀÁ”ˆ”¥ıÄÃ®']=base64_decode('YWJz');$phpjiami_decrypt['Áı‹ÃÖÖ¥Ã”¾ÃÀı®ˆÄÖÃ®ÖÄ®ÖÖ‹ˆÃÖÃÃ¾ˆ']=base64_decode('c3ByaW50Zg==');$phpjiami_decrypt['Á®Ã®ÀÁÖÃ‹¥ÁÖÃÖ¯”ÖÁ‹ÃÀıÖ”¾Ã¥ÁÃ']=base64_decode('c3RybGVu');$phpjiami_decrypt['®ˆ¾¯ÖÖ”Ã‹Ö‹‹ÖÖˆ‹¥”ıÖÀÃ‹ÖÖÃÁˆÃÄ¾']=base64_decode('aW5fYXJyYXk=');$phpjiami_decrypt['¯‹‹Ã¯¯®Ã¯ÃÀÁÃ”Ã‹®”Ã¥À¥ˆÃÁÖÄ‹ÖÖ']=base64_decode('cm91bmQ=');$phpjiami_decrypt['‹Ö¾Ö¥‹ÀÃ‹‹Ä¯ˆˆ®”Àˆ‹¥ˆÁÁ‹Ö¾Ö']=base64_decode('YXJyYXlfZmlsdGVy');$phpjiami_decrypt['Áı®‹Á¾¯ÖÃÀÄÖÃ®ÖÃÃ®¾À¾Ã¾ÃÃÁˆ¾®Ã¥Ã']=base64_decode('c3RyX3JlcGxhY2U=');$phpjiami_decrypt['ÃÁ”‹À¥”ıÖˆÄÁ‹ı”ıÃ®‹®ÄÖÀÖ¾‹ÁÃÖı']=base64_decode('cmVuYW1l');$phpjiami_decrypt['ÃÁ¥ÃÖÄˆ®Ö¾¾‹¯ÄˆÖÖÁ”Ö¥¯¯Ä¾ÀˆÄˆ']=base64_decode('aW1wbG9kZQ==');$phpjiami_decrypt['Ö¾ÁÖı”ˆÀÄÖÃˆ¥ˆıÄ®ÃÁÄÖÃı‹®Ä‹ˆÄ‹']=base64_decode('bmwyYnI=');$phpjiami_decrypt['Ö¥¯¯ÃÀ‹¾¥¾À¾®‹¾ÃÁÀÖÖ”‹Àı®Ö¯ÃÁÃÖÃ']=base64_decode('bXRfcmFuZA==');$phpjiami_decrypt['ˆÁÄÀ®¾ÃÃÄıÄ‹ÁÖ¥ˆ”ÃÖˆ”ÀÁˆ”‹®‹¾']=base64_decode('bW92ZV91cGxvYWRlZF9maWxl');$phpjiami_decrypt['À¯®‹Ö¾Ãı”‹‹¯¯Ã¯”¾‹‹®ıÃ‹ˆÁÄÁ®ÁˆÃ¾']=base64_decode('cGF0aGluZm8=');$phpjiami_decrypt['ˆÖ¯¥ÖÀ¥ÁÖˆÖÖ®‹ÖÄ¾ˆ‹Ö‹ÃÃ®ı”¾®¾®']=base64_decode('Y291bnQ=');$phpjiami_decrypt['¯ˆÖıÃ®À¥¯ÖÁÖˆ‹¥ÖÃ®¥Ã¥ıÄÖÁÖÁÖ‹¯®Ã']=base64_decode('dHJpbQ==');$phpjiami_decrypt['¥ÄˆÃ”Ã®Ãˆ®ıÁ‹¾¯”Á¯Á®¥Ö”ı¾Ö¥ÁÖÖ¾Ö']=base64_decode('ZmlsZV9leGlzdHM='); ?>
<?php
class userAction extends UsersAction {public function _initialize(){parent::_initialize();$info =$this->visitor->get();$info =M('user')->find($this->visitor->info['id']);$this->assign('info', $info);D('order')->checkTime();}public function person(){if($this->visitor->is_login){$this->redirect('user/index');}$setting=C('ftx_score_rule');$this->assign('setting',$setting);$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/person.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','ä¸ªäººä¸­å¿ƒ');$this->_config_seo(array('title' => 'ä¸ªäººä¸­å¿ƒ 	-	' . C('ftx_site_name'),));$this->display();}public function additem(){if ($this->info['login_type'] == 1){$this->error('éå•†å®¶ç”¨æˆ·ï¼');}if (IS_POST){$data =I('post.info');$data['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['start_time'] =$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']($data['start_time']);$data['end_time'] =$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']($data['end_time']);$data['remain'] =$data['num'];$data['deposit'] =$data['num'] * $data['price'];$data['seller'] =$this->info['id'];$data['status'] =1;$result =M('free')->add($data);if ($result){$this->success('å‘å¸ƒæˆåŠŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜å®¡æ ¸å¹¶æ”¯ä»˜ä¿è¯é‡‘ï¼');}else {$this->error('å‘å¸ƒå¤±è´¥');}}$this->_config_seo(array('title' => 'å‘å¸ƒæ´»åŠ¨	-	' . C('ftx_site_name'),));$this->display();}public function edititem(){if ($this->info['login_type'] == 1){$this->error('éå•†å®¶ç”¨æˆ·ï¼');}$id =I('get.id');$item =M('free')->where("id = $id and seller =" . $this->info['id'])->find();if ($item['status'] == 1){if (IS_POST){$data =I('post.info');$data['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['start_time'] =$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']($data['start_time']);$data['end_time'] =$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']($data['end_time']);$data['remain'] =$data['num'];$data['deposit'] =$data['num'] * $data['price'];$data['status'] =1;$result =M('free')->save($data);if ($result){$this->success('ç¼–è¾‘æˆåŠŸï¼Œè¯·è”ç³»ç®¡ç†å‘˜å®¡æ ¸å¹¶æ”¯ä»˜ä¿è¯é‡‘ï¼');}else {$this->error('ç¼–è¾‘å¤±è´¥');}}$this->_config_seo(array('title' => 'ç¼–è¾‘æ´»åŠ¨	-	' . C('ftx_site_name'),));$this->item =$item;$this->display('additem');}else {$this->error('æ“ä½œé”™è¯¯ï¼');}}public function delitem(){if ($this->info['login_type'] == 1){$this->error('éå•†å®¶ç”¨æˆ·ï¼');}$id =I('get.id');$result =M('free')->where("id = $id and seller =" . $this->info['id'])->setfield('status', '3');if ($result){$this->success('æ’¤é”€æˆåŠŸ');}else {$this->error('æ’¤é”€æ´»åŠ¨å‡ºé”™');}}public function item(){if ($this->info['login_type'] == 1){$this->error('éå•†å®¶ç”¨æˆ·ï¼');}$map =array();$map['seller'] =$this->visitor->info['id'];$free_item_mod =M('free');$pagesize =5;$count =$free_item_mod->where($map)->count('id');$pager =$this->_pager($count, $pagesize);$items =$free_item_mod->where($map)->limit($pager->firstRow . ',' . $pager->listRows)->order('id DESC')->select();foreach ($items as $key => $val){$items[$key]['baoming'] =$val['num'] - $val['remain'];}$this->assign('items', $items);$this->assign('page', $pager->fshow());$this->_config_seo(array('title' => 'æ´»åŠ¨ç®¡ç†	-	' . C('ftx_site_name'),));$this->display();}public function info(){$do =I('do');if (IS_POST && $do ='myinfo'){if(IS_AJAX){$name=I('post.name');$tableval=I('post.tableval');$oldpassword =I('old_password');$passport =$this->_user_server();$result =$passport->edit($this->visitor->info['id'], $oldpassword, array($tableval => $name));if ($result){$this->ajaxReturn('200','æ“ä½œæˆåŠŸ');}else {$this->ajaxReturn('201','æ“ä½œå¤±è´¥');}}else {$oldpassword =I('old_password');$qq =I('qq');$email =I('email');$mobile =I('mobile');$nickname =safe_replace(I('nickname'));$gender =I('sex')==""?127:I('sex');$passport =$this->_user_server();$result =$passport->edit($this->visitor->info['id'], $oldpassword, array('qq' => $qq, 'email' => $email, 'mobile' => $mobile, 'nickname' => $nickname, 'gender' => $gender));if ($result){$GLOBALS['phpjiami_decrypt']['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®']('Content-type: text/html; charset=utf-8');die('<script language="javascript">alert("èµ„æ–™ä¿®æ”¹æˆåŠŸï¼");this.location.href="' . U('user/info'). '";</script>');}else {$this->success(L('edit_failed'), U('user/info'));}}}if($this->ismobile){$act=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ'](I('get.act'));if(empty($act)||$act>3||$act<1){$this->redirect('user/index');}if($act==1){$css='nameChange';$title='æ˜µç§°ä¿®æ”¹';$tableval='nickname';$type='text';$value=$this->info['nickname'];}elseif($act==2){$css='mail';$title='é‚®ç®±è®¾ç½®';$tableval='email';$type='email';$value=$this->info['email'];}else {$css='mobile';$title='æ‰‹æœºè®¾ç½®';$tableval='mobile';$type='number';$value=$this->info['mobile'];}$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/'.$css.'.css', );$this->assign('js_arr',$this->js_arr);$this->assign('act',$act);$this->assign('css_arr',$this->css_arr);$this->assign('page_title',$title);$this->assign('tableval',$tableval);$this->assign('type',$type);$this->assign('value',$value);}$this->_config_seo(array('title' => $title.' - ä¸ªäººè®¾ç½®	-	' . C('ftx_site_name'),));$this->display();}public function complain(){if ($this->info['login_type'] != 1){$complain =M('complain')->where('sid =' . $this->info['id'])->select();}else {$complain =M('complain')->where('uid =' . $this->info['id'])->select();}$this->nowtime =time();$this->complain =$complain;$this->_config_seo(array('title' => 'ç”³è¯‰ç®¡ç†	-	' . C('ftx_site_name'),));$this->display();}public function inputOrderID(){if ($this->info['login_type'] != 1)$this->error('éæ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®');if (IS_POST){$data['items_id'] =I('post.items_id');$data['order_id'] =I('post.order_id');$data['uid'] =$this->info['id'];$orderStatus =D('order')->where("uid = " . $data['uid'] . " and items_id =" . $data['items_id'])->getfield('status');$data['order_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();if ($orderStatus == 'å¾…å¡«å†™è®¢å•å·'){if ($GLOBALS['phpjiami_decrypt']['”¾ˆÃÃıˆÁÖ¯ı¾‹ÁÀÖÖÄ¥¥ÖÀÖÖˆˆˆ®ÖÄÄ']($data['order_id'])){$data['status'] ='å¾…å®¡æ ¸è®¢å•å·';$result =D('order')->where("uid = " . $data['uid'] . " and items_id =" . $data['items_id'])->save($data);if ($result){$this->success('æäº¤æˆåŠŸ');}else {$this->error('æäº¤å¤±è´¥');}}else {$this->error('å•å·å¿…é¡»æ˜¯æ•°å­—');}}else {$this->error('æäº¤æœ‰è¯¯');}}}public function cash(){if ($this->info['login_type'] != 1)$this->error('éæ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®');$cashlist =M('apply_order')->where("status = 'å·²æç°'")->order('add_time desc')->limit(30)->select();foreach ($cashlist as $key => $val){$cashlist[$key]['username'] ="**" . $GLOBALS['phpjiami_decrypt']['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ'](getTableValue($val['uid'], 'id', 'user', 'username'), 2, 3). "**";}$this->cashlist =$cashlist;$this->tixianzhong =M('apply_order')->where("(status = 'ç”³è¯·ä¸­') and uid =" . $this->info['id'])->sum('money');$this->_config_seo(array('title' => 'è´¦æˆ·æç°	-	' . C('ftx_site_name'),));$this->financeList =M('finance')->where("uid = " . $this->info['id'])->order("add_time desc")->select();$this->display();}public function zhifu(){if ($this->info['login_type'] == 1)$this->error('éå•†å®¶ç”¨æˆ·ï¼');if (IS_POST){$did =I('post.did');$deposit =M('free')->where("id = $did and seller =" . $this->info['id'])->getField('deposit');IS_AJAX && $this->ajaxReturn(1, 'success', $deposit);}}public function checkOrder(){if ($this->info['login_type'] == 1)$this->error('éå•†å®¶ç”¨æˆ·ï¼');$order_mod =D('order');$id =I('get.id');$check =I('get.check');$order =$order_mod->find($id);if ($order['seller'] != $this->info['id'])$this->error('éæ³•æ“ä½œ');if (!$order)$this->error('æ•°æ®æœ‰è¯¯');if ($order['status'] != 'å¾…å®¡æ ¸è®¢å•å·')$this->error('æ•°æ®æœ‰è¯¯');if ($check == 1){$order['status'] ='å·²è¿”è¿˜';$result =M('user')->where("id = " . $order['uid'])->setInc('money', $order['price']);$finance['uid'] =$order['uid'];$finance['money'] =$order['price'];$finance['memo'] =$order['title'] . 'è¿”æ¬¾';$finance['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();M('finance')->add($finance);$order_mod->save($order);if ($result){$this->success('å¤„ç†æˆåŠŸï¼');}else {$this->error('æäº¤å¤±è´¥');}}else {$order['status'] ='è®¢å•å·æœ‰è¯¯';M('free')->where('id = ' . $order['items_id'])->setInc('remain', 1);$result =$order_mod->save($order);if ($result){$this->success('å¤„ç†æˆåŠŸï¼');}else {$this->error('æäº¤å¤±è´¥');}}}public function orderManage(){if ($this->info['login_type'] == 1)$this->error('éå•†å®¶ç”¨æˆ·ï¼');$p =I('p', 1);$page_size =20;$start =$page_size * ($p - 1);$count =D('order')->where("seller = " . $this->info['id'])->count('id');$pager =$this->_pager($count, $page_size);$this->orderList =M('order')->where("seller = " . $this->info['id'])->order("id desc")->select();$this->assign('page', $pager->fshow());$this->display();}public function ConfirmPay(){if ($this->info['login_type'] == 1)$this->error('éå•†å®¶ç”¨æˆ·ï¼');if (IS_POST){$did =I('post.did');$item =M('free')->where("id = $did and seller =" . $this->info['id'])->find();if (!$item)$this->error('è¯¥å•†å“ä¸å­˜åœ¨ï¼è¯·åˆ·æ–°é¡µé¢é‡æ–°æäº¤ï¼');if ($item['paid'] >= $item['deposit']){$this->error('å·²ç»æˆåŠŸæ”¯ä»˜ï¼è¯·åˆ·æ–°é¡µé¢ï¼');}elseif ($item['deposit'] > $this->info['money']){$this->error('ä½™é¢ä¸å¤Ÿï¼Œè¯·è”ç³»å®¢æœå……å€¼ï¼');}else {$needpay =$item['deposit'] - $item['paid'];$result =M('user')->where("id = " . $this->info['id'])->setDec('money', $needpay);if ($result){$item['paid'] =$item['deposit'];$item['status'] =4;M('free')->where("id = $did and seller =" . $this->info['id'])->save($item);$this->success('æ”¯ä»˜æˆåŠŸï¼è¯·è€å¿ƒç­‰å¾…å®¡æ ¸ä¸Šçº¿ï¼');}else {$this->error('æ‰£è´¹å¤±è´¥ï¼');}}}}public function apply_cash(){if ($this->info['login_type'] != 1)$this->error('éæ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®');if (IS_POST){$yanzheng =$GLOBALS['phpjiami_decrypt']['Ä‹ıÖ¯‹®Ã”ÃÖ®‹ÀÖÖÀÀ”ÃÁÖ¥”Ã®‹ÄÃÁÄÖ']($_POST['yanzheng']);$jine =$_POST['jine'];if ($yanzheng != $this->info['password'])$this->error('è¾“å…¥å¯†ç æœ‰è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');if ($this->info['money'] < $jine)$this->error('ææ¬¾é¢åº¦ä¸èƒ½å¤§äºè´¦æˆ·ä½™é¢ï¼');$data['uid'] =$this->info['id'];$data['alipay'] =$this->info['alipay'];$data['name'] =$this->info['name'];$data['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['status'] ='ç”³è¯·ä¸­';$data['money'] =$jine;$result =M('apply_order')->add($data);if ($result){M('user')->where('id =' . $this->info['id'])->setDec('money', $jine);$finance['uid'] =$this->info['id'];$finance['money'] =-$jine;$finance['memo'] ='ç”³è¯·ææ¬¾';$finance['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();M('finance')->add($finance);$this->success('ç”³è¯·æˆåŠŸï¼Œè¯·è€å¿ƒç­‰å€™ï¼');}else {$this->error('æäº¤å¤±è´¥ï¼');}}else {if ($this->info['alipay'] == '' || $this->info['name'] == '')$this->error('è¯·å…ˆè®¾ç½®æ‚¨çš„æ”¯ä»˜å®ä¿¡æ¯');$cashlist =M('apply_order')->where("status = 'å·²æç°'")->order('add_time desc')->limit(30)->select();foreach ($cashlist as $key => $val){$cashlist[$key]['username'] ="**" . $GLOBALS['phpjiami_decrypt']['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ'](getTableValue($val['uid'], 'id', 'user', 'username'), 2, 3). "**";}$this->cashlist =$cashlist;$this->tixianzhong =M('apply_order')->where("(status = 'ç”³è¯·ä¸­') and uid =" . $this->info['id'])->sum('money');$this->_config_seo(array('title' => 'è´¦æˆ·æç°	-	' . C('ftx_site_name'),));$this->display();}}public function order(){if ($this->info['login_type'] != 1)$this->error('éæ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®');$p =I('p', 1);$page_size =20;$start =$page_size * ($p - 1);$count =D('order')->where('uid =' . $this->info['id'])->count('id');$pager =$this->_pager($count, $page_size);$orderList =D('order')->where('uid =' . $this->info['id'])->order('add_time DESC')->limit($start . ',' . $page_size)->select();$this->assign('page', $pager->fshow());foreach ($orderList as $key => $val){if ($val['status'] == 'å¾…å¡«å†™è®¢å•å·'){$orderList[$key]['stop_time'] =$val['add_time'] + (86400 * 3);}elseif ($val['status'] == 'å¾…å®¡æ ¸è®¢å•å·'){$orderList[$key]['stop_time'] =$val['order_time'] + (86400 * 15);}}$this->nowtime =time();$this->orderList =$orderList;$this->_config_seo(array('title' => 'è®¢å•ç®¡ç†	-	' . C('ftx_site_name'),));$this->display();}public function chashen(){if (IS_POST){$orid =I('post.orid');$result =M('complain')->where("order_id = $orid")->find();if ($this->info['login_type'] != 1){if ($result['sid'] != $this->info['id'])$this->error('error');}else {if ($result['uid'] != $this->info['id'])$this->error('error');}if ($result){$result['title'] =getTableValue($result['item_id'], 'id', 'free', 'title');$result['username'] =$this->info['username'];$result['add_time'] =$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d H:i:s', $result['add_time']);if ($result['reply_time'] != '')$result['reply_time'] =$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d H:i:s', $result['reply_time']);IS_AJAX && $this->ajaxReturn(1, 'success', $result);}else {IS_AJAX && $this->ajaxReturn(0, 'error', $result);}}}public function shensu(){if ($this->info['login_type'] != 1)$this->error('éæ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®');if (IS_POST){$data['order_id'] =I('post.order_id');$data['ss_content'] =I('post.ss_content');$data['qq'] =I('post.qq');$data['wangwang'] =I('post.wangwang');$data['phone'] =I('post.phone');$order =D('order')->where("id = " . $data['order_id'])->find();if (!$order)$this->error('æäº¤å¤±è´¥');if ($data['ss_content'] == '')$this->error('ç”³è¯‰å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');$data['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['status'] ='ç­‰å¾…å›å¤';$data['item_id'] =$order['items_id'];$data['uid'] =$this->info['id'];$data['sid'] =getTableValue($order['items_id'], 'id', 'free', 'seller');import('ORG.Net.UploadFile');$upload =new UploadFile();$upload->maxSize =3145728;$upload->allowExts =array('jpg', 'gif', 'png', 'jpeg');$upload->savePath ='./data/upload/complain/';if ($_FILES['ss_pz']){$info =$upload->uploadOne($_FILES['ss_pz']);$data['ss_pz'] =$info[0]['savepath'] . $info[0]['savename'];if (!$info)$this->error("ä¸Šä¼ å‡ºé”™");}if ($_FILES['ss_pz2']){$info2 =$upload->uploadOne($_FILES['ss_pz2']);$data['ss_pz2'] =$info2[0]['savepath'] . $info2[0]['savename'];if (!$info2)$this->error("ä¸Šä¼ å‡ºé”™");}$result =M('complain')->add($data);if ($result){D('order')->where("id = " . $data['order_id'])->setField('status', 'ç”³è¯‰ä¸­');$this->success('æäº¤ç”³è¯‰æˆåŠŸ');}else {$this->error('æäº¤å¤±è´¥');}}}public function reply_complain(){if ($this->info['login_type'] != 2)$this->error('éå•†å®¶ç”¨æˆ·ä¸èƒ½è®¿é—®');if (IS_POST){$data['id'] =I('post.id');$data['reply_content'] =I('post.reply_content');if ($data['reply_content'] == '')$this->error('ç”³è¯‰å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');$data['reply_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['status'] ='ç­‰å¾…è£å†³';import('ORG.Net.UploadFile');$upload =new UploadFile();$upload->maxSize =3145728;$upload->allowExts =array('jpg', 'gif', 'png', 'jpeg');$upload->savePath ='./data/upload/complain/';if ($_FILES['reply_pz']){$info =$upload->uploadOne($_FILES['reply_pz']);$data['reply_pz'] =$info[0]['savepath'] . $info[0]['savename'];if (!$info)$this->error("ä¸Šä¼ å‡ºé”™");}$result =M('complain')->save($data);if ($result){$this->success('æäº¤æˆåŠŸ');}else {$this->error('æäº¤å¤±è´¥');}}}public function reply_complain2(){if ($this->info['login_type'] != 2)$this->error('éå•†å®¶ç”¨æˆ·ä¸èƒ½è®¿é—®');if (IS_POST){$data['order_id'] =I('post.id');$data['id'] =M('complain')->where("order_id = " . $data['order_id'])->getField('id');$data['reply_content'] =I('post.reply_content');if ($data['reply_content'] == '')$this->error('ç”³è¯‰å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');$data['reply_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$data['status'] ='ç­‰å¾…è£å†³';import('ORG.Net.UploadFile');$upload =new UploadFile();$upload->maxSize =3145728;$upload->allowExts =array('jpg', 'gif', 'png', 'jpeg');$upload->savePath ='./data/upload/complain/';if ($_FILES['reply_pz']){$info =$upload->uploadOne($_FILES['reply_pz']);$data['reply_pz'] =$info[0]['savepath'] . $info[0]['savename'];if (!$info)$this->error("ä¸Šä¼ å‡ºé”™");}$result =M('complain')->save($data);if ($result){$this->success('æäº¤æˆåŠŸ');}else {$this->error('æäº¤å¤±è´¥');}}}public function inputOrder(){if ($this->info['login_type'] != 1)$this->error('éæ™®é€šç”¨æˆ·ä¸èƒ½è®¿é—®');if (IS_POST){$data['id'] =I('post.id');$data['order_id'] =I('post.order_id');$orderStatus =D('order')->where("id =" . $data['id'])->getfield('status');$data['order_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();if ($GLOBALS['phpjiami_decrypt']['”¾ˆÃÃıˆÁÖ¯ı¾‹ÁÀÖÖÄ¥¥ÖÀÖÖˆˆˆ®ÖÄÄ']($data['order_id'])){$data['status'] ='å¾…å®¡æ ¸è®¢å•å·';$result =D('order')->save($data);if ($result){$this->success('æäº¤æˆåŠŸ');}else {$this->error('æäº¤å¤±è´¥');}}else {$this->error('å•å·å¿…é¡»æ˜¯æ•°å­—');}}}public function alipay(){$do =I('do');if (IS_POST && $do ='myalipay'){$oldpassword =I('old_password');$alipay =I('alipay');$name =I('name');$passport =$this->_user_server();$result =$passport->edit($this->visitor->info['id'], $oldpassword, array('alipay' => $alipay, 'name' => $name));if ($result){$GLOBALS['phpjiami_decrypt']['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®']('Content-type: text/html; charset=utf-8');die('<script language="javascript">alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼");this.location.href="' . U('user/password'). '";</script>');exit($re);}}$this->_config_seo(array('title' => 'æç°è´¦å·	-	' . C('ftx_site_name'),));$this->display();}public function login(){$this->visitor->is_login && $this->redirect('user/index');if (IS_POST){$username =$this->_post('username', 'trim');$password =$this->_post('password', 'trim');$remember =$this->_post('remember');if (empty($username)){IS_AJAX && $this->ajaxReturn(0, L('please_input'). L('username'),1);$this->error(L('please_input'). L('username'));}if (empty($password)){IS_AJAX && $this->ajaxReturn(0, L('please_input'). L('password'),2);$this->error(L('please_input'). L('password'));}$passport =$this->_user_server();$uid =$passport->auth($username, $password);if (!$uid){IS_AJAX && $this->ajaxReturn(0, $passport->get_error(),3);$this->error($passport->get_error());}$this->visitor->login($uid, $remember);$tag_arg =array('uid' => $uid, 'uname' => $username, 'action' => 'login');tag('login_end', $tag_arg);$synlogin =$passport->synlogin($uid);if (IS_AJAX){$this->ajaxReturn(1, L('login_successe'). $synlogin);}else {$from =$this->_post('from', 'trim');redirect($from);$this->success(L('login_successe'). $synlogin, $from);}}else {if (!empty($_GET['synlogout'])){$passport =$this->_user_server();$synlogout =$passport->synlogout();}if (IS_AJAX){$resp =$this->fetch('dialog:login');$this->ajaxReturn(1, '', $resp);}else {$from=U('user/index');$this->assign('from', $from);$this->assign('synlogout', $synlogout);$this->_config_seo(array('title' => C('ftx_site_name'). 'ç™»å½•,ç™»é™†' . C('ftx_site_name'). '    -    ' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/login.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','ç™»å½•');}$this->display();}}}public function logout(){$this->visitor->logout();$passport =$this->_user_server();$synlogout =$passport->synlogout();redirect($_SERVER['HTTP_REFERER']);}public function binding(){$user_bind_info =object_to_array(cookie('user_bind_info'));$this->assign('user_bind_info', $user_bind_info);$this->_config_seo();$this->display();}public function bf_register(){$this->visitor->is_login && $this->redirect('user/index');$this->_config_seo(array('title' => 'æ³¨å†Œ	-	' . C('ftx_site_name'),));$this->display();}public function register(){$this->visitor->is_login && $this->redirect('user/index');if (IS_POST){$login_type =$this->_post('type', 'trim', 'reg');if ($login_type == 'reg'){$agreement =$this->_post('agreement');!$agreement && $this->error(L('agreement_failed'));$captcha =$this->_post('captcha', 'trim');if (session('captcha')!= $GLOBALS['phpjiami_decrypt']['Ä‹ıÖ¯‹®Ã”ÃÖ®‹ÀÖÖÀÀ”ÃÁÖ¥”Ã®‹ÄÃÁÄÖ']($captcha)){$this->error(L('captcha_failed'));}}$username =$this->_post('username', 'trim');$email =$this->_post('email', 'trim');$login_type =$this->_post('login_type', 'trim');$qq =$this->_post('qq', 'trim');$isMatched1 =$GLOBALS['phpjiami_decrypt']['ı®”ıÁÁ®ÁÁ¥¾ÃÄ®¯¯®Ã”¥®ˆ¥Ö‹¥Ä”À®']('/[1-9]([0-9]{5,11})/', $qq, $matches);if(empty($isMatched1)){$this->error("qqæ ¼å¼é”™è¯¯");}$isMatched2 =$GLOBALS['phpjiami_decrypt']['ı®”ıÁÁ®ÁÁ¥¾ÃÄ®¯¯®Ã”¥®ˆ¥Ö‹¥Ä”À®']('/\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/', $email, $matches);if(empty($isMatched2)){$this->error("é‚®ç®±æ ¼å¼é”™è¯¯");}$isMatched3 =$GLOBALS['phpjiami_decrypt']['ı®”ıÁÁ®ÁÁ¥¾ÃÄ®¯¯®Ã”¥®ˆ¥Ö‹¥Ä”À®']('/[A-Za-z0-9]{6,15}/', $username, $matches);if(empty($isMatched3)){$this->error("ç”¨æˆ·åä¸º6-15ä½æ•°æ®æˆ–å­—æ¯ç»„æˆ");}$password =$this->_post('password', 'trim');$isMatched4 =$GLOBALS['phpjiami_decrypt']['ı®”ıÁÁ®ÁÁ¥¾ÃÄ®¯¯®Ã”¥®ˆ¥Ö‹¥Ä”À®']('/(\w+){6,16}/', $password, $matches);if(empty($isMatched4)){$this->error("å¯†ç ä¸º6-16ä½å­—æ¯æ•°å­—");}$repassword =$this->_post('repassword', 'trim');if ($password != $repassword){$this->error(L('inconsistent_password'));}$gender =$this->_post('gender', 'intval', '0');$ipban_mod =D('ipban');$ipban_mod->clear();$is_ban =$ipban_mod->where("(login_type='name' AND name='" . $username . "') OR (login_type='email' AND name='" . $email . "')")->count();$is_ban && $this->error(L('register_ban'));$passport =$this->_user_server();$uid =$passport->register($username, $password, $email, $gender, $login_type, $qq);!$uid && $this->error($passport->get_error());if (cookie('user_bind_info')){$user_bind_info =object_to_array(cookie('user_bind_info'));$oauth =new oauth($user_bind_info['login_type']);$bind_info =array('ftx_uid' => $uid, 'ftx_username' => $username, 'keyid' => $user_bind_info['keyid'], 'bind_info' => $user_bind_info['bind_info'],);$oauth->bindByData($bind_info);$this->_save_avatar($uid, $user_bind_info['temp_avatar']);cookie('user_bind_info', NULL);}$tag_arg =array('uid' => $uid, 'uname' => $username, 'action' => 'register');tag('register_end', $tag_arg);$union_date =array('uid' => $uid, 'username' => $username);D('user')->union_reg($union_date);$this->visitor->login($uid);$tag_arg =array('uid' => $uid, 'uname' => $username, 'action' => 'login');tag('login_end', $tag_arg);$synlogin =$passport->synlogin($uid);$this->success(L('register_successe'). $synlogin, U('user/index'));}else {if (!C('ftx_reg_status')){$this->error(C('ftx_reg_closed_reason'));}$this->login_type=1;$this->formtitle ='ç”¨æˆ·æ³¨å†Œ';$this->_config_seo(array('title' => ' ç”¨æˆ·æ³¨å†Œ	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/register.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æ³¨å†Œ');}$this->display();}}private function _save_avatar($uid, $img){$avatar_size =$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ'](',', C('ftx_avatar_size'));$avatar_dir =C('ftx_attach_path'). 'avatar/' . avatar_dir($uid);!$GLOBALS['phpjiami_decrypt']['ÃÀÖÃˆÁ¥Ã¾ÃÃ‹Ö¾¥ÃÖ¯ÁÄ‹ˆ‹®Ä¯Á®Ö¾”¥']($avatar_dir)&& $GLOBALS['phpjiami_decrypt']['ÃÄıÖ¯Ã‹‹ÃÖˆ¥ˆ”Á¾¯ı®ÁÃ®ˆ‹¯¥ˆÁ®ÖÁ']($avatar_dir, 0777, true);$img =C('ftx_attach_path'). 'avatar/temp/' . $img;foreach ($avatar_size as $size){Image::thumb($img, $avatar_dir . $GLOBALS['phpjiami_decrypt']['Ä‹ıÖ¯‹®Ã”ÃÖ®‹ÀÖÖÀÀ”ÃÁÖ¥”Ã®‹ÄÃÁÄÖ']($uid). '_' . $size . '.jpg', '', $size, $size, true);}@$GLOBALS['phpjiami_decrypt']['Ã¯¾Ã®ı”ı¾ˆ‹¯Ö¾Ö”‹®ˆÁÃÀıÁ¯ˆÃ®']($img);}public function msgtip(){$result =D('user_msgtip')->get_list($this->visitor->info['id']);$this->ajaxReturn(1, '', $result);}public function minfo(){if($this->ismobile){$info =$this->visitor->get();$notice =M('article')->where(array('cate_id' => '1'))->select();$this->assign('notice', $notice);$this->assign('info', $info);$this->_config_seo(array('title' => L('base_setting'). '	-	' . C('ftx_site_name'),));$setting=C('ftx_score_rule');$reg_num=M('score_log')->where('uid='.$info['id'].' and action="union_reg"')->count('id');$this->assign('reg_num',$reg_num);$sign_mod =M('sign');$sign_info =$sign_mod->field('id,username,last_date,sign_count')->where(array('uid'=>$this->visitor->info['id']))->find();$last_date=$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']($GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d'));if($sign_info['last_date']==$last_date){$sign_num=$sign_info['sign_count'];}$this->assign('sign_num',$sign_num?$sign_num:0);$this->assign('setting',$setting);$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/setup.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','ä¸ªäººè®¾ç½®');}else {$this->redirect('user/info');}$this->_config_seo(array('title' => 'ä¸ªäººè®¾ç½® 	-	' . C('ftx_site_name'),));$this->display();}public function index(){if (IS_POST){foreach ($_POST as $key => $val){$_POST[$key] =Input::deleteHtmlTags($val);}$data['gender'] =$this->_post('gender', 'intval');$data['province'] =$this->_post('province', 'trim');$data['city'] =$this->_post('city', 'trim');$data['intro'] =$this->_post('intro', 'trim');$data['truename'] =$this->_post('truename', 'trim');$data['mobile'] =$this->_post('mobile', 'intval');$data['telephone'] =$this->_post('telephone', 'trim');$data['address'] =safe_replace($this->_post('address', 'trim'));$data['qq'] =$this->_post('qq', 'intval');$data['wangwang'] =$this->_post('wangwang', 'trim');$birthday =$this->_post('birthday', 'trim');$birthday =$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ']('-', $birthday);$data['byear'] =$birthday[0];$data['bmonth'] =$birthday[1];$data['bday'] =$birthday[2];if (false !== M('user')->where(array('id' => $this->visitor->info['id']))->save($data)){$msg =array('status' => 1, 'info' => L('edit_success'));}else {$msg =array('status' => 0, 'info' => L('edit_failed'));}$this->assign('msg', $msg);}$info =$this->visitor->get();$notice =M('article')->where(array('cate_id' => '1'))->select();$this->assign('notice', $notice);$this->assign('info', $info);$this->_config_seo(array('title' => L('base_setting'). '	-	' . C('ftx_site_name'),));if($this->ismobile){$setting=C('ftx_score_rule');$reg_num=M('score_log')->where('uid='.$info['id'].' and (action="union_reg" or action="union_visit")')->count('id');$this->assign('reg_num',$reg_num);$sign_mod =M('sign');$sign_info =$sign_mod->field('id,username,last_date,sign_count')->where(array('uid'=>$this->visitor->info['id']))->find();$last_date=$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']($GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y-m-d'));if($sign_info['last_date']==$last_date){$sign_num=$sign_info['sign_count'];}$this->assign('sign_num',$sign_num?$sign_num:0);$this->assign('setting',$setting);$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/person.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','ä¸ªäººä¸­å¿ƒ');}$this->_config_seo(array('title' => 'ä¸ªäººä¸­å¿ƒ 	-	' . C('ftx_site_name'),));$this->display();}public function upload_avatar(){if (!empty($_FILES['avatar']['name'])){$avatar_size =$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ'](',', C('ftx_avatar_size'));$uid =$GLOBALS['phpjiami_decrypt']['”¯ÀıÃ‹¾‹ˆıı‹”ı¾Ö®Á‹ÃÀÁ”ˆ”¥ıÄÃ®']($GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']($this->visitor->info['id']));$suid =$GLOBALS['phpjiami_decrypt']['Áı‹ÃÖÖ¥Ã”¾ÃÀı®ˆÄÖÃ®ÖÄ®ÖÖ‹ˆÃÖÃÃ¾ˆ']("%09d", $uid);$dir1 =$GLOBALS['phpjiami_decrypt']['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ']($suid, 0, 3);$dir2 =$GLOBALS['phpjiami_decrypt']['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ']($suid, 3, 2);$dir3 =$GLOBALS['phpjiami_decrypt']['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ']($suid, 5, 2);$avatar_dir =$dir1 . '/' . $dir2 . '/' . $dir3 . '/';$suffix ='';foreach ($avatar_size as $size){$suffix .= '_' . $size . ',';}$result =$this->_upload($_FILES['avatar'], 'avatar/' . $avatar_dir, array('width' => C('ftx_avatar_size'), 'height' => C('ftx_avatar_size'), 'remove_origin' => true, 'suffix' => trim($suffix, ','), 'ext' => 'jpg',), md5($uid));if ($result['error']){$this->ajaxReturn(0, $result['info']);}else {$data =__ROOT__ . '/data/upload/avatar/' . $avatar_dir . $GLOBALS['phpjiami_decrypt']['Ä‹ıÖ¯‹®Ã”ÃÖ®‹ÀÖÖÀÀ”ÃÁÖ¥”Ã®‹ÄÃÁÄÖ']($uid). '_' . $size . '.jpg?' . $GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$this->ajaxReturn(1, L('upload_success'), $data);}}else {$this->ajaxReturn(0, L('illegal_parameters'));}}public function password(){if (IS_POST){$oldpassword =$this->_post('old', 'trim');$password =$this->_post('newpassword', 'trim');$repassword =$this->_post('agin', 'trim');!$password && $this->error(L('no_new_password'));$password != $repassword && $this->error(L('inconsistent_password'));$passlen =$GLOBALS['phpjiami_decrypt']['Á®Ã®ÀÁÖÃ‹¥ÁÖÃÖ¯”ÖÁ‹ÃÀıÖ”¾Ã¥ÁÃ']($password);if ($passlen < 6 || $passlen > 20){$this->error(L('password_length_error'));}$passport =$this->_user_server();$result =$passport->edit($this->visitor->info['id'], $oldpassword, array('password' => $password));if($this->ismobile){if ($result){$this->ajaxReturn('200','å¯†ç ä¿®æ”¹æˆåŠŸ');}else {$this->ajaxReturn('200','ä¿®æ”¹å¤±è´¥');}exit;}else {if ($result){$GLOBALS['phpjiami_decrypt']['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®']('Content-type: text/html; charset=utf-8');die('<script language="javascript">alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼");this.location.href="' . U('user/password'). '";</script>');}else {$msg =array('status' => 0, 'info' => $passport->get_error());}}$this->assign('msg', $msg);}if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/passwordChange.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','å¯†ç ä¿®æ”¹');}$this->_config_seo(array('title' => L('edit_password'). '	-	' . C('ftx_site_name'),));$this->display();}public function union(){$info =$this->visitor->get();$union_url =$GLOBALS['phpjiami_decrypt']['Á®ˆıˆ”¯ÖıÁ”¾Ö¾®ÃÖÖÖ®”ı””ÃÖ'](C('ftx_site_url'), 0, -1). U('inval/index', array('id' => $info['id']));$share_url ='{\'url\':\'' . $union_url . '\'}';$union['per_visit'] =C('ftx_score_rule.union_visit');$union['count_visit'] =C('ftx_score_rule.union_visit')* C('ftx_score_rule.union_visit_nums');$union['per_reg'] =C('ftx_score_rule.union_reg');$union['count_reg'] =C('ftx_score_rule.union_reg')* C('ftx_score_rule.union_reg_nums');$this->assign('union', $union);$this->assign('union_url', $union_url);$this->assign('share_url', $share_url);$this->_config_seo(array('title' => 'é‚€è¯·å¥½å‹è®¿é—® -	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', '/tkjidicms/wap/js/clipboard.min.js', );$this->css_arr =array('/tkjidicms/wap/css/friend.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','é‚€è¯·å¥½å‹');$file1='union_num_'.$info['id'];$file2='union_score_'.$info['id'];if(!S($file1)){$union_num=M('score_log')->where('uid='.$info['id'].' and action="union_visit" or action="union_reg"')->count('id');S($file1,$union_num,60*10);}if(!S($file2)){$union_score=M('score_log')->where('uid='.$info['id'].' and action="union_visit" or action="union_reg"')->sum('score');S($file2,$union_score,60*10);}$union_num=S($file1);$union_score=S($file2);$this->assign('union_num',$union_num);$this->assign('union_score',$union_score);}$this->display();}public function unionlist(){if(IS_AJAX){$p =I('page', 2);$page_size =20;$start =$page_size * ($p - 1);$union_list =M('union')->field('id,uid,username,ip,score,ouid,ousername,add_time')->where(array('uid' => $this->visitor->info['id']))->limit($start . ',' . $page_size)->order('add_time DESC')->select();if($union_list){foreach($union_list as $k=>$item){$union_list[$k]['time1']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y.m.d',$item['add_time']);$union_list[$k]['time2']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('H:i:s',$item['add_time']);}$this->ajaxReturn('200','',$orderlist);}else {$this->ajaxReturn('201');}}else {$p =I('p', 1);$page_size =20;$start =$page_size * ($p - 1);$count =M('union')->where(array('uid' => $this->visitor->info['id']))->count('id');$pager =$this->_pager($count, $page_size);$union_list =M('union')->field('id,uid,username,ip,score,ouid,ousername,add_time')->where(array('uid' => $this->visitor->info['id']))->limit($start . ',' . $page_size)->order('add_time DESC')->select();$this->assign('union_list', $union_list);$this->assign('page', $pager->fshow());$this->_config_seo(array('title' => L('user_union'). '	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/inviteDetail.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','é‚€è¯·æ˜ç»†');}$this->_config_seo(array('title' => 'é‚€è¯·æ˜ç»†	-	' . C('ftx_site_name'),));$this->display();}}public function gift(){$map =array();$map['uid'] =$this->visitor->info['id'];$score_total=M('user')->where('id='.$this->visitor->info['id'])->getField('score');$this->assign('score_total',$score_total);$score_order_mod =M('score_order');$p =I('p', 1);$page_size =20;$start =$page_size * ($p - 1);$count =$score_order_mod->where($map)->count('id');$pager =$this->_pager($count, $page_size);$order_list =$score_order_mod->where($map)->limit($start . ',' . $page_size)->order('id DESC')->select();if($order_list){foreach($order_list as $k=>$item){$order_list[$k]['pro']=M('score_item')->where('id='.$item['item_id'])->find();}}$this->assign('order_list', $order_list);$this->assign('page', $pager->fshow());$this->_curr_menu('order');$this->_config_seo(array('title' => L('my_gift'). '	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/exchange.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æˆ‘çš„å…‘æ¢');}$this->display();}public function mingxi(){if(IS_AJAX){$map =array();$map['uid'] =$this->visitor->info['id'];$pagesize =15;$p=I('page',2);$score_log_mod =M('score_log');$logs_list =$score_log_mod->field('id,action,score,add_time')->where($map)->limit(($p-1)*$pagesize,$pagesize)->order('id DESC')->select();if($logs_list){foreach($logs_list as $k=>$item){$logs_list[$k]['time1']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']("Y.m.d",$item['add_time']);$logs_list[$k]['time2']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']("H:i:s",$item['add_time']);$logs_list[$k]['action']=L($item['action']);}$this->ajaxReturn('200','',$logs_list);}else {$this->ajaxReturn('201');}exit;}else {$map =array();$map['uid'] =$this->visitor->info['id'];$score_total=M('user')->where('id='.$this->visitor->info['id'])->getField('score');$score_log_mod =M('score_log');$pagesize =15;$type=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ'](I('t'));switch ($type){case 1: {$map['addtime']=array('egt',$GLOBALS['phpjiami_decrypt']['ıÁˆı”ÖıÃÖÃ‹Á®ˆÖÀ”¥¥‹”ÄÁ”¯¥Á¾¯Ã']('-3 month'));$map['addtime']=array('elt',$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']());$typestr="è¿‘ä¸‰ä¸ªæœˆè®°å½•";break;}case 2: {$map['score']=array('egt',0);$typestr="ç§¯åˆ†è¿›è´¦è®°å½•";break;}case 3: {$map['score']=array('lt',0);$typestr="ç§¯åˆ†æ¶ˆè€—è®°å½•";break;}default: {$typestr="å…¨éƒ¨";}}$this->assign('typestr',$typestr);$count =$score_log_mod->where($map)->count('id');$pager =$this->_pager($count, $pagesize);$logs_list =$score_log_mod->field('id,action,score,add_time')->where($map)->limit($pager->firstRow . ',' . $pager->listRows)->order('id DESC')->select();$this->assign('logs_list', $logs_list);$this->assign('page', $pager->fshow());$this->assign('score_total', $score_total);$this->assign('totalPages',$pager->totalPages);$this->_config_seo(array('title' => L('user_score'). '	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/inteDetail.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title',L('user_score'));}$this->display();}}public function bind(){$bind_list =M('user_bind')->field('type')->where(array('uid' => $this->visitor->info['id']))->select();$binds =array();if ($bind_list){foreach ($bind_list as $val){$binds[] =$val['type'];}}$oauth_list =$this->oauth_list;foreach ($oauth_list as $type => $_oauth){$oauth_list[$type]['isbind'] ='0';if ($GLOBALS['phpjiami_decrypt']['®ˆ¾¯ÖÖ”Ã‹Ö‹‹ÖÖˆ‹¥”ıÖÀÃ‹ÖÖÃÁˆÃÄ¾']($type, $binds)){$oauth_list[$type]['isbind'] ='1';}}$this->assign('oauth_list', $oauth_list);$this->_config_seo(array('title' => L('user_bind'). '	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/bind.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title',L('user_bind'));}$this->display();}public function like(){$p =I('p', 1);$page_size =20;$start =$page_size * ($p - 1);$ids_list =D('items_like')->field('id,num_iid')->limit($start . ',' . $page_size)->where(array('uid' => $this->visitor->info['id']))->order('id desc')->select();$ids =array();if ($ids_list){foreach ($ids_list as $val){$ids[] =$val['num_iid'];}}$where['num_iid'] =array('in', $ids);$where['pass'] ='1';$items =D('items')->field('id,num_iid,ems,cu,title,price,coupon_price,pic_url,likes,status,coupon_start_time,coupon_end_time,shop_type,volume')->where($where)->select();$count =D('items_like')->where(array('uid' => $this->visitor->info['id']))->count();$pager =$this->_pager($count, $page_size);foreach ($items as $item){$item_list[$item['id']] =$item;$item_list[$item['id']]['class'] =D('items')->status($item['status'], $item['coupon_start_time'], $item['coupon_end_time']);$item_list[$item['id']]['zk'] =$GLOBALS['phpjiami_decrypt']['¯‹‹Ã¯¯®Ã¯ÃÀÁÃ”Ã‹®”Ã¥À¥ˆÃÁÖÄ‹ÖÖ'](($item['coupon_price'] / $item['price'])* 10, 1);}$this->assign('page', $pager->jshow());$this->assign('count', $count);$this->assign('items', $item_list);$this->_config_seo(array('title' => 'æˆ‘çš„æ”¶è—	-	' . C('ftx_site_name'),));$this->display();}public function ajax_check(){$login_type =I('login_type', 'email', 'trim');$user_mod =D('user');switch ($login_type){case 'email': $email =I('J_email', '', 'trim');$user_mod->email_exists($email)? $this->ajaxReturn(0): $this->ajaxReturn(1);break;case 'username': $username =I('J_username', '', 'trim');$user_mod->name_exists($username)? $this->ajaxReturn(0): $this->ajaxReturn(1);break;}}public function msg(){$uid =$this->visitor->info['id'];$msg_mod =M('msg');$do =I('do', 'in', 'trim');$tpl ='msg_in';if ('in' == $do){$map['tuid'] =array('in', array($uid, '0'));$pagesize =10;$count =$msg_mod->where($map)->order('id DESC')->count('id');$pager =$this->_pager($count, $pagesize);$msg_list =$msg_mod->where($map)->order('id DESC')->limit($pager->firstRow . ',' . $pager->listRows)->select();$this->assign('msg_list', $msg_list);$this->assign('page_bar', $pager->fshow());$tpl ='msg_in';}else if ('out' == $do){$map['fuid'] =$uid;$pagesize =10;$count =$msg_mod->where($map)->order('id DESC')->count('id');$pager =$this->_pager($count, $pagesize);$msg_list =$msg_mod->where($map)->order('id DESC')->limit($pager->firstRow . ',' . $pager->listRows)->select();$this->assign('msg_list', $msg_list);$this->assign('page_bar', $pager->fshow());$tpl ='msg_out';}else if ('send' == $do){$tpl ='msg_send';}else if ('savemsg' == $do){$content =I('content');$data['fuid'] =$this->visitor->info['id'];$data['fname'] =$this->visitor->info['username'];$data['tuid'] =999999;$data['tname'] ='SYSTEM';$data['info'] =$content;$data['status'] =0;$data['add_time'] =$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$msg_mod->add($data);$this->redirect('user/msg');}else if ('del' == $do){$ids =I('ids');$t =I('t', 'in');foreach ($ids as $id){$map['id'] =$id;if ('in'){$map['tuid'] =$uid;}else if ('out' == $t){$map['fuid'] =$uid;}$msg_mod->where($map)->delete();}$this->redirect('user/msg');}$this->_config_seo(array('title' => 'ç«™å†…ä¿¡   -  ',));$this->display($tpl);}public function kuaidi(){$this->_config_seo(array('title' => 'å¿«é€’æŸ¥è¯¢   -  ',));$this->display();}public function avatar(){$this->display();}public function addresslist(){$userinfo=M('user')->find($this->visitor->info['id']);$addressinfo=M('address')->where('user_id='.$this->visitor->info['id'])->find();if (IS_POST){$msg ="";$addressid=$this->_post('addressid', 'intval');$data['realname'] =$this->_post('realname', 'trim');$data['mobile'] =$this->_post('mobile', 'trim');$data['address'] =safe_replace($this->_post('address', 'trim'));if(empty($data['address'])){die('<script language="javascript">alert("è¯¦ç»†åœ°å€é”™è¯¯ï¼");this.location.href="' . U('user/addresslist'). '";</script>');}$data['province'] =$this->_post('cho_Province', 'trim');$data['city'] =$this->_post('cho_City', 'trim');$data['area'] =$this->_post('cho_Area', 'trim');if($GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ']($addressid)==1){$data['id']=$addressinfo['id'];$res=M('address')->save($data);}else {if(!empty($addressinfo)){$msg =array('status' => 0, 'info' => 'æ”¶è·åœ°å€å·²å­˜åœ¨ï¼æ— éœ€å†æ–°æ·»åŠ ');if(IS_AJAX){return json_decode($msg);}die('<script language="javascript">alert("æ”¶è·åœ°å€å·²å­˜åœ¨ï¼æ— éœ€å†æ–°æ·»åŠ ï¼");this.location.href="' . U('user/addresslist'). '";</script>');}else {$data['user_id'] =$this->visitor->info['id'];$res=M('address')->add($data);}}if(IS_AJAX){if($res!==false){$msg =array('status' => 1, 'info' => 'æ“ä½œæˆåŠŸ');}else {$msg =array('status' => 0, 'info' => 'æ“ä½œå¤±è´¥');}return json_decode($msg);}else {if($res!==false){$GLOBALS['phpjiami_decrypt']['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®']('Content-type: text/html; charset=utf-8');die('<script language="javascript">alert("æ“ä½œæˆåŠŸï¼");this.location.href="' . U('user/addresslist'). '";</script>');}else {$msg =array('status' => 0, 'info' => 'æ“ä½œå¤±è´¥');}}$this->assign('msg', $msg);}$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', '/tkjidicms/wap/js/jquery.scs.min.js', '/tkjidicms/wap/js/CNAddrArr.min.js', );$this->css_arr =array('/tkjidicms/wap/css/add.css', '/tkjidicms/wap/css/layout.min.css', '/tkjidicms/wap/css/scs.min.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æ”¶è´§åœ°å€');$this->assign('userinfo',$userinfo);$this->assign('addressinfo',$addressinfo);$this->_config_seo(array('title' => 'æ”¶è´§åœ°å€	-	' . C('ftx_site_name'),));$this->display();}public function shai(){if (IS_POST){$shai_pic=$this->_post('shai_pic', 'trim');if(empty($shai_pic)){$this->error('è¯·ä¸Šä¼ æ™’å•å›¾ç‰‡ï¼');}$shai_picarr=$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ'](",",$shai_pic);$shai_picarr=$GLOBALS['phpjiami_decrypt']['‹Ö¾Ö¥‹ÀÃ‹‹Ä¯ˆˆ®”Àˆ‹¥ˆÁÁ‹Ö¾Ö']($shai_picarr);$img=array();foreach($shai_picarr as $item){$to=$GLOBALS['phpjiami_decrypt']['Áı®‹Á¾¯ÖÃÀÄÖÃ®ÖÃÃ®¾À¾Ã¾ÃÃÁˆ¾®Ã¥Ã']('temp/','preview/',$item);$GLOBALS['phpjiami_decrypt']['ÃÁ”‹À¥”ıÖˆÄÁ‹ı”ıÃ®‹®ÄÖÀÖ¾‹ÁÃÖı']($item,$to);$img[]=$to;}$data['shai_pic']=(!empty($img))?$GLOBALS['phpjiami_decrypt']['ÃÁ¥ÃÖÄˆ®Ö¾¾‹¯ÄˆÖÖÁ”Ö¥¯¯Ä¾ÀˆÄˆ'](",",$img):$shai_pic;$data['order_num']=$this->_post('order_num', 'trim');$data['orderprice']=$this->_post('order_price', 'trim');$data['desc']=safe_replace($this->_post('desc', 'trim'));if(empty($data['desc'])){die('<script language="javascript">alert("ä½ æäº¤çš„æè¿°ä¿¡æ¯æœ‰è¯¯ï¼");this.location.href="' . U('user/shai'). '";</script>');}$data['user_id']=$this->visitor->info['id'];$data['username']=$this->visitor->info['username'];$data['addtime']=$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']();$res=M('shaiorder')->add($data);if($res){die('<script language="javascript">alert("æ™’å•æäº¤ï¼éœ€å®¡æ ¸åè·å¾—ç§¯åˆ†ï¼");this.location.href="' . U('user/shailist'). '";</script>');}}$shai_score=M('score_log')->where('uid='.$this->visitor->info['id'].' and action="shaidan"')->sum('score');$shai_num=M('score_log')->where('uid='.$this->visitor->info['id'].' and action="shaidan"')->count('id');$this->assign('shai_score',$shai_score);$this->assign('shai_num',$shai_num);$this->_config_seo(array('title' => 'æˆ‘è¦æ™’å•	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/iwant.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æˆ‘è¦æ™’å•');}$this->display();}public function shailist(){if(IS_AJAX){$per=10;$p=I('page',2);$item_list=array();$item_list=M('shaiorder')->where('user_id='.$this->visitor->info['id'])->order('id desc')->limit(($p-1)*$per,$per)->select();if($item_list){foreach($item_list as $k=>$item){if(!empty($item['shai_pic'])){$pic=$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ'](",",$item['shai_pic']);$item_list[$k]['shai_pic']=$pic[0];$item_list[$k]['desc']=$GLOBALS['phpjiami_decrypt']['Ö¾ÁÖı”ˆÀÄÖÃˆ¥ˆıÄ®ÃÁÄÖÃı‹®Ä‹ˆÄ‹']($item['desc']);$item_list[$k]['time1']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('Y.m.d',$item['addtime']);$item_list[$k]['time2']=$GLOBALS['phpjiami_decrypt']['¾”ıÁ®Ö®ÄÄ¯¾ı‹ÖÁˆÖÖÃÃÁ”¥”Ã¾ÄÄ”Á”']('H:i:s',$item['addtime']);}}$this->ajaxReturn('200','',$item_list);}else {$this->ajaxReturn('201');}}else {$pagesize =15;$count =M('shaiorder')->where('user_id='.$this->visitor->info['id'])->count('id');$pager =$this->_pager($count, $pagesize);$shailist=M('shaiorder')->where('user_id='.$this->visitor->info['id'])->order('id desc')->limit(($pager->firstRow . ',' . $pager->listRows))->select();if($shailist){foreach($shailist as $k=>$item){if(!empty($item['shai_pic'])){$pic=$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ'](",",$item['shai_pic']);$shailist[$k]['shai_pic']=$pic[0];}}}$this->assign('page', $pager->fshow());$this->assign('shailist',$shailist);$this->assign('totalPages',$pager->totalPages);$shai_score=M('score_log')->where('uid='.$this->visitor->info['id'].' and action="shaidan"')->sum('score');$shai_num=M('score_log')->where('uid='.$this->visitor->info['id'].' and action="shaidan"')->count('id');$this->assign('shai_score',$shai_score);$this->assign('shai_num',$shai_num);$this->_config_seo(array('title' => 'æ™’å•è®°å½•	-	' . C('ftx_site_name'),));if($this->ismobile){$this->js_arr =array('/tkjidicms/wap/js/jquery-3.2.1.min.js', );$this->css_arr =array('/tkjidicms/wap/css/mySquare.css', );$this->assign('js_arr',$this->js_arr);$this->assign('css_arr',$this->css_arr);$this->assign('page_title','æˆ‘çš„æ™’å•');}$this->display();}}public function upfilemore(){$fileArr =$_FILES['files'];$previewPath ="data/upload/temp/";creatDir($previewPath);$data =array('sta'=>TRUE,'msg'=>'å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');$ext =getExt($fileArr['name'][0]);$max=$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ'](C('ftx_shai_pic'))?$GLOBALS['phpjiami_decrypt']['”‹¥Ö¯Ö‹ıÁ®ÖÀ®¾¾ÄÖˆ®Ä¯”ı¾‹¾ÄÃıÃ'](C('ftx_shai_pic')):1024;$arrExt =array('jpg','jpeg','gif','png');$size=$GLOBALS['phpjiami_decrypt']['Áı‹ÃÖÖ¥Ã”¾ÃÀı®ˆÄÖÃ®ÖÄ®ÖÖ‹ˆÃÖÃÃ¾ˆ']("%.1f",($fileArr["size"][0]/(1024)));if($size>$max){$data['sta'] =FALSE;$data['msg'] ='Error:æ–‡ä»¶ã€Š'.$fileArr['name'][0].'ã€‹è¶…è¿‡'.$max.'KBï¼Œä¸èƒ½ä¸Šä¼ ï¼';}if(!$GLOBALS['phpjiami_decrypt']['®ˆ¾¯ÖÖ”Ã‹Ö‹‹ÖÖˆ‹¥”ıÖÀÃ‹ÖÖÃÁˆÃÄ¾']($ext,$arrExt)){$data['sta'] =FALSE;$data['msg'] ='Error:æ–‡ä»¶ã€Š'.$fileArr['name'][0].'ã€‹ä¸æ˜¯å›¾ç‰‡æˆ–é‡‡ç”¨äº†ä¸åˆé€‚çš„æ‰©å±•åï¼';}else {if($fileArr['error'][0] == 0){$previewName ='pre_'.$GLOBALS['phpjiami_decrypt']['Ä‹ıÖ¯‹®Ã”ÃÖ®‹ÀÖÖÀÀ”ÃÁÖ¥”Ã®‹ÄÃÁÄÖ']($GLOBALS['phpjiami_decrypt']['Ö¥¯¯ÃÀ‹¾¥¾À¾®‹¾ÃÁÀÖÖ”‹Àı®Ö¯ÃÁÃÖÃ'](1000,9999)).$GLOBALS['phpjiami_decrypt']['ÁııÃ¯¥‹¯‹®”ıÃ®ÃÁÄ”ÀÖ‹Ã¯ÖÖı¥Ö‹']().'.'.$ext;$previewSrc =$previewPath.$previewName;if(!$GLOBALS['phpjiami_decrypt']['ˆÁÄÀ®¾ÃÃÄıÄ‹ÁÖ¥ˆ”ÃÖˆ”ÀÁˆ”‹®‹¾']($fileArr['tmp_name'][0],$previewSrc)){$data['sta'] =FALSE;$data['msg'] =$fileArr['name'][0].'å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼';}else {$data['msg'] =$fileArr['name'][0].'å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼';$data['previewSrc'] =$previewSrc;}}}echo json_encode($data);}}function getExt($filename){$ext =$GLOBALS['phpjiami_decrypt']['À¯®‹Ö¾Ãı”‹‹¯¯Ã¯”¾‹‹®ıÃ‹ˆÁÄÁ®ÁˆÃ¾']($filename, PATHINFO_EXTENSION);return $ext;}function creatDir($path){$arr =$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ']('/',$path);$dirAll ='';$result =FALSE;if($GLOBALS['phpjiami_decrypt']['ˆÖ¯¥ÖÀ¥ÁÖˆÖÖ®‹ÖÄ¾ˆ‹Ö‹ÃÃ®ı”¾®¾®']($arr)> 0){foreach($arr as $key=>$value){$tmp =$GLOBALS['phpjiami_decrypt']['¯ˆÖıÃ®À¥¯ÖÁÖˆ‹¥ÖÃ®¥Ã¥ıÄÖÁÖÁÖ‹¯®Ã']($value);if($tmp != ''){$dirAll .= $tmp.'/';if(!$GLOBALS['phpjiami_decrypt']['¥ÄˆÃ”Ã®Ãˆ®ıÁ‹¾¯”Á¯Á®¥Ö”ı¾Ö¥ÁÖÖ¾Ö']($dirAll)){$GLOBALS['phpjiami_decrypt']['ÃÄıÖ¯Ã‹‹ÃÖˆ¥ˆ”Á¾¯ı®ÁÃ®ˆ‹¯¥ˆÁ®ÖÁ']($dirAll,0777,true);}}}}}