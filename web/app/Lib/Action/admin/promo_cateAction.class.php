<?php global $phpjiami_decrypt;$phpjiami_decrypt['¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥”ÃÃı®¥®ÄÄ¯Ã¯¥Öˆ']=base64_decode('X2luaXRpYWxpemU=');$phpjiami_decrypt['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®']=base64_decode('aGVhZGVy');$phpjiami_decrypt['¥ıÃÄ¥®ÃÃÀ¯®ıÀ¥Ä‹ÖÖˆ¾®ÁÃˆÄ¾Äˆ‹']=base64_decode('VQ==');$phpjiami_decrypt['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']=base64_decode('TA==');$phpjiami_decrypt['Áı‹ÃÖÖ¥Ã”¾ÃÀı®ˆÄÖÃ®ÖÄ®ÖÖ‹ˆÃÖÃÃ¾ˆ']=base64_decode('c3ByaW50Zg==');$phpjiami_decrypt['®ˆ¾¯ÖÖ”Ã‹Ö‹‹ÖÖˆ‹¥”ıÖÀÃ‹ÖÖÃÁˆÃÄ¾']=base64_decode('aW5fYXJyYXk=');$phpjiami_decrypt['ÄÀÁ¾ÃˆÃ¥ÃˆÖÖÃÖÁ¯ÃÖÃÀÀÃÖÃˆ®ÖÁÖıÖ']=base64_decode('YXJyYXlfcG9w');$phpjiami_decrypt['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ']=base64_decode('ZXhwbG9kZQ==');$phpjiami_decrypt['Áı®‹Á¾¯ÖÃÀÄÖÃ®ÖÃÃ®¾À¾Ã¾ÃÃÁˆ¾®Ã¥Ã']=base64_decode('c3RyX3JlcGxhY2U=');$phpjiami_decrypt['‹ÃÃ‹Ã®Ã”Ö‹‹¥ˆÁÃÖÖÀÀ”®Á¥ÃÀ®ı¥‹”Ö']=base64_decode('c3RycG9z');$phpjiami_decrypt['¯ˆÖıÃ®À¥¯ÖÁÖˆ‹¥ÖÃ®¥Ã¥ıÄÖÁÖÁÖ‹¯®Ã']=base64_decode('dHJpbQ=='); ?>
<?php
 class promo_cateAction extends BackendAction {public function _initialize(){parent::$GLOBALS['phpjiami_decrypt']['¯ÀÖÖ¯”ÃÁ¯ÃÖˆ‹Ã¥”ÃÃı®¥®ÄÄ¯Ã¯¥Öˆ']();$this->_mod =D('promo_cate');$GLOBALS['phpjiami_decrypt']['¯¯”‹¯¯¾®¥Ã”®ÄıÁ¥¯”Ãˆ¥Ã‹”®¯¾ˆ®'](base64_decode('Q29udGVudC1UeXBlOnRleHQvaHRtbDsgY2hhcnNldD11dGYtOA=='));if (!$this->checkAuth()){echo 'ç½‘ç«™æœªæˆæƒï¼Œéœ€è¦æˆæƒæ‰å¯æ­£å¸¸ä½¿ç”¨ï¼Œå®˜ç½‘ç”³è¯· <a href="http:\\/\\/www.tkjidi.com" target="_blank">www.tkjidi.com</a>  å’¨è¯¢å®¢æœQQ 800061081';exit();}}public function index(){$sort =$this->_request('sort', 'trim', 'ordid');$order =$this->_request('order', 'trim', 'ASC');$tree =new Tree();$tree->icon =array('â”‚ ', 'â”œâ”€ ', 'â””â”€ ');$tree->nbsp ='&nbsp;&nbsp;&nbsp;';$result =$this->_mod->order($sort . ' ' . $order)->select();$array =array();foreach ($result as $r){$r['str_status'] ='<img data-tdtype="toggle" data-id="' . $r['id'] . '" data-field="status" data-value="' . $r['status'] . '" src="__STATIC__/images/admin/toggle_' . ($r['status'] == 0 ? 'disabled' : 'enabled'). '.gif" />';$r['str_manage'] ='<a href="javascript:;" class="J_showdialog" data-uri="' . $GLOBALS['phpjiami_decrypt']['¥ıÃÄ¥®ÃÃÀ¯®ıÀ¥Ä‹ÖÖˆ¾®ÁÃˆÄ¾Äˆ‹']('promo_cate/add', array('pid' => $r['id'])). '" data-title="' . $GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('add_promo_cate'). '" data-id="add" data-width="500" data-height="360">' . $GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('add_promo_subcate'). '</a> |
                                <a href="javascript:;" class="J_showdialog" data-uri="' . $GLOBALS['phpjiami_decrypt']['¥ıÃÄ¥®ÃÃÀ¯®ıÀ¥Ä‹ÖÖˆ¾®ÁÃˆÄ¾Äˆ‹']('promo_cate/edit', array('id' => $r['id'])). '" data-title="' . $GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('edit'). ' - ' . $r['name'] . '" data-id="edit" data-width="500" data-height="290">' . $GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('edit'). '</a> |
                                <a href="javascript:;" data-acttype="ajax" class="J_confirmurl" data-uri="' . $GLOBALS['phpjiami_decrypt']['¥ıÃÄ¥®ÃÃÀ¯®ıÀ¥Ä‹ÖÖˆ¾®ÁÃˆÄ¾Äˆ‹']('promo_cate/delete', array('id' => $r['id'])). '" data-msg="' . $GLOBALS['phpjiami_decrypt']['Áı‹ÃÖÖ¥Ã”¾ÃÀı®ˆÄÖÃ®ÖÄ®ÖÖ‹ˆÃÖÃÃ¾ˆ']($GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('confirm_delete_one'), $r['name']). '">' . $GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('delete'). '</a>';$r['parentid_node'] =($r['pid'])? ' class="child-of-node-' . $r['pid'] . '"' : '';$array[] =$r;}$str ='<tr id=\'node-$id\' $parentid_node>
                <td align=\'center\'><input type=\'checkbox\' value=\'$id\' class=\'J_checkitem\'></td>
                <td>$spacer<span data-tdtype=\'edit\' data-field=\'name\' data-id=\'$id\' class=\'tdedit\'>$name</span></td>
                <td align=\'center\'>$id</td>
                <td align=\'center\'><span data-tdtype=\'edit\' data-field=\'ordid\' data-id=\'$id\' class=\'tdedit\'>$ordid</span></td>
                <td align=\'center\'>$str_status</td>
                <td align=\'center\'>$str_manage</td>
                </tr>';$tree->init($array);$list =$tree->get_tree(0, $str);$this->assign('list', $list);$big_menu =array('title' => $GLOBALS['phpjiami_decrypt']['ÃÖıÀˆı®‹¥ÖÀÄˆˆ”ÄÃ¥ı‹¥ıÀÖÄ‹ÀÖ¾ÖÁ']('add_promo_cate'), 'iframe' => $GLOBALS['phpjiami_decrypt']['¥ıÃÄ¥®ÃÃÀ¯®ıÀ¥Ä‹ÖÖˆ¾®ÁÃˆÄ¾Äˆ‹']('promo_cate/add'), 'id' => 'add', 'width' => '500', 'height' => '290');$this->assign('big_menu', $big_menu);$this->assign('list_table', true);$this->display();}public function _before_add(){$pid =$this->_get('pid', 'intval', 0);if ($pid){$spid =$this->_mod->where(array('id' => $pid))->getField('spid');$spid =$spid ? $spid . $pid : $pid;$this->assign('spid', $spid);}}protected function _before_insert($data =''){if ($this->_mod->name_exists($data['name'], $data['pid'])){$this->ajaxReturn(0, L('promo_cate_already_exists'));}$data['spid'] =$this->_mod->get_spid($data['pid']);return $data;}protected function _before_update($data =''){if ($this->_mod->name_exists($data['name'], $data['pid'], $data['id'])){$this->ajaxReturn(0, L('promo_cate_already_exists'));}$old_pid =$this->_mod->field('img,pid')->where(array('id' => $data['id']))->find();if ($data['pid'] != $old_pid['pid']){$wp_spid_arr =$this->_mod->get_child_ids($data['id'], true);if ($GLOBALS['phpjiami_decrypt']['®ˆ¾¯ÖÖ”Ã‹Ö‹‹ÖÖˆ‹¥”ıÖÀÃ‹ÖÖÃÁˆÃÄ¾']($data['pid'], $wp_spid_arr)){$this->ajaxReturn(0, L('cannot_move_to_child'));}$data['spid'] =$this->_mod->get_spid($data['pid']);}return $data;}public function ajax_upload_img(){if (!empty($_FILES['img']['name'])){$result =$this->_upload($_FILES['img'], 'promo_cate', array('width' => '80', 'height' => '80'));if ($result['error']){$this->ajaxReturn(0, $result['info']);}else {$ext =$GLOBALS['phpjiami_decrypt']['ÄÀÁ¾ÃˆÃ¥ÃˆÖÖÃÖÁ¯ÃÖÃÀÀÃÖÃˆ®ÖÁÖıÖ']($GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ']('.', $result['info'][0]['savename']));$data['img'] =$GLOBALS['phpjiami_decrypt']['Áı®‹Á¾¯ÖÃÀÄÖÃ®ÖÃÃ®¾À¾Ã¾ÃÃÁˆ¾®Ã¥Ã']('.' . $ext, '_thumb.' . $ext, $result['info'][0]['savename']);$this->ajaxReturn(1, L('operation_success'), $data['img']);}}else {$this->ajaxReturn(0, L('illegal_parameters'));}}public function move(){if (IS_POST){$data['pid'] =$this->_post('pid', 'intval');$ids =$this->_post('ids');$target_spid =$this->_mod->where(array('id' => $data['pid']))->getField('spid');$ids_arr =$GLOBALS['phpjiami_decrypt']['”ÖÖÄ‹¾Ä¾¯ÃÖ¾ÖÁÖÃÀ‹ÀÃ”¾Ã®Ö””ˆÖÄ'](',', $ids);foreach ($ids_arr as $id){if (false !== $GLOBALS['phpjiami_decrypt']['‹ÃÃ‹Ã®Ã”Ö‹‹¥ˆÁÃÖÖÀÀ”®Á¥ÃÀ®ı¥‹”Ö']($target_spid . $data['pid'] . '|', $id . '|')){$this->ajaxReturn(0, L('cannot_move_to_child'));}}$data['spid'] =$this->_mod->get_spid($data['pid']);$this->_mod->where(array('id' => array('in', $ids)))->save($data);$this->ajaxReturn(1, L('operation_success'), '', 'move');}else {$ids =$GLOBALS['phpjiami_decrypt']['¯ˆÖıÃ®À¥¯ÖÁÖˆ‹¥ÖÃ®¥Ã¥ıÄÖÁÖÁÖ‹¯®Ã']($this->_request('id'), ',');$this->assign('ids', $ids);$resp =$this->fetch();$this->ajaxReturn(1, '', $resp);}}public function ajax_getchilds(){$id =$this->_get('id', 'intval');$map =array('pid' => $id);$map['status'] ='1';$return =$this->_mod->field('id,name')->where($map)->select();if ($return){$this->ajaxReturn(1, L('operation_success'), $return);}else {$this->ajaxReturn(0, L('operation_failure'));}}}