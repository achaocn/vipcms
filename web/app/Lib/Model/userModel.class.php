<?php
class userModel extends Model {protected $_validate =array(array('username', 'require', '{%username_require}'), array('repassword', 'password', '{%inconsistent_password}', 0, 'confirm'), array('email', 'email', '{%email_error}'), array('password', '6,20', '{%password_length_error}', 0, 'length', 1), array('username', '', '{%username_exists}', 0, 'unique', 1), );protected $_map =array('sex' =>'gender', 'mail' =>'email', );protected $_auto =array(array('password','md5',1,'function'), array('reg_time','time',1,'function'), array('reg_ip','get_client_ip',1,'function'), );public function rename($map, $newname){if ($this->where(array('username'=>$newname))->count('id')){return false;}$this->where($map)->save(array('username'=>$newname));$uid =$this->where(array('username'=>$newname))->getField('id');M('items')->where(array('uid'=>$uid))->save(array('uname'=>$newname));return true;}public function name_exists($name, $id =0){$where ="username='" . $name . "' AND id<>'" . $id . "'";$result =$this->where($where)->count('id');if ($result){return true;}else {return false;}}public function email_exists($email, $id =0){$where ="email='" . $email . "' AND id<>'" . $id . "'";$result =$this->where($where)->count('id');if ($result){return true;}else {return false;}}public function union_reg($date){$ip =get_client_ip();if (D('union')->where(array('ip'=>$ip))->find()){$union_user =D('union')->where(array('ip'=>$ip))->find();if(!$union_user['ouid']){$union_date['score'] =C('ftx_score_rule.union_reg');$union_date['ouid'] =$date['uid'];$union_date['ousername']=$date['username'];D('union')->where(array('ip'=>$ip))->save($union_date);$this->where(array('id'=>$union_user['uid']))->setInc('score',C('ftx_score_rule.union_reg'));$score_log_date['uid'] =$union_user['uid'];$score_log_date['uname'] =$union_user['username'];$score_log_date['action'] ='union_reg';$score_log_date['score'] =C('ftx_score_rule.union_reg');D('score_log')->create($score_log_date);D('score_log')->add();$union_date['ouid'] =$date['uid'];$union_date['ousername']=$date['username'];D('union')->where(array('ip'=>$ip))->save($union_date);}}}}